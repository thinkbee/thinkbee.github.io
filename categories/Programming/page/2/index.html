<!doctype html>
<html lang="ko"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>카테고리: Programming - IT Tech blogging</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="thinkbee blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="thinkbee blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Machine learning, Deep learning, Python, Data science and Mobile Programming like Android"><meta property="og:type" content="website"><meta property="og:title" content="IT Tech blogging"><meta property="og:url" content="https://blog.thinkbee.kr/"><meta property="og:site_name" content="IT Tech blogging"><meta property="og:description" content="Machine learning, Deep learning, Python, Data science and Mobile Programming like Android"><meta property="og:locale" content="ko_KR"><meta property="og:image" content="https://blog.thinkbee.kr/img/og_image.png"><meta property="article:author" content="Gangtai Goh"><meta property="article:tag" content="Machine learning, Deep learning, Python, Data science, Android, Ubuntu, Linux, macOS"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.thinkbee.kr/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.thinkbee.kr"},"headline":"IT Tech blogging","image":["https://blog.thinkbee.kr/img/og_image.png"],"author":{"@type":"Person","name":"Gangtai Goh"},"publisher":{"@type":"Organization","name":"IT Tech blogging","logo":{"@type":"ImageObject","url":"https://blog.thinkbee.kr/images/thinkbee_logo.png"}},"description":"Machine learning, Deep learning, Python, Data science and Mobile Programming like Android"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/vs2015.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-5ZH90CZ414" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-5ZH90CZ414');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script data-ad-client="ca-pub-1465716454138955" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/thinkbee_logo.png" alt="IT Tech blogging" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Blog</a><a class="navbar-item" href="/documents">Doc</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/thinkbee"><i class="fab fa-github"></i></a><a class="navbar-item search" title="검색" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-four-fifths-tablet is-four-fifths-desktop is-four-fifths-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">카테고리</a></li><li class="is-active"><a href="#" aria-current="page">Programming</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-17T00:00:00.000Z" title="7/17/2023, 9:00:00 AM">2023-07-17</time>&nbsp;게시 됨</span><span class="level-item"><time dateTime="2023-07-17T13:52:50.406Z" title="7/17/2023, 10:52:50 PM">2023-07-17</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Database/">Database</a></span><span class="level-item">13분안에 읽기 (약 1883 단어)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/mysqlclient_SSH_Tunneling-59f215a18e7e/">MySQL/MariaDB Server SSH Over Tunneling</a></p><div class="content"><p>클라이언트에서 원격 서버 MySQL DB server 접속시 SSH turnneling 을 이용할 수 있다.</p>
<ol>
<li>ssh tunneling 이해</li>
<li>SSHTunnelForwarder 클래스</li>
<li>HeidiSQL ssh tunnel 사용</li>
</ol>
<h1 id="ssh-tnnneling-이해"><a href="#ssh-tnnneling-이해" class="headerlink" title="ssh tnnneling 이해"></a>ssh tnnneling 이해</h1><p>비 암호화된 통신을 지원하는 원격 프로그램이 암호화된 통신을 지원하는 ssh 를 사용해서 원격지에 접속이 가능하게 한다. 직접 TLS&#x2F;SSL 구현을 하지 않더라도 SSL 로 암호화된 통신 채널을 통해 안전하게 프로그램을 사용할 수 있다.</p>
<p>터널링은 아래 같이 SSH 서버를 통해서 원격지에서 SSH 통신을 지원한다.</p>
<p><img src='https://www.ssh.com/hubfs/Imported_Blog_Media/Securing_applications_with_ssh_tunneling___port_forwarding-2.png' width=600> 링크 <a href="#footnote2">참고2</a> 의 그림</p>
<p>MySQL client 에서 Database server 포트 3306으로 직접 접속하지 않고 ssh 를 이용해 원격 서버에 연결하고 원격 서버 내부에서 mysql server 에 접속해 사용하게 해준다.</p>
<h1 id="SSHTunnelForwarder-이용-tunneling-사용"><a href="#SSHTunnelForwarder-이용-tunneling-사용" class="headerlink" title="SSHTunnelForwarder 이용 tunneling 사용"></a>SSHTunnelForwarder 이용 tunneling 사용</h1><p>sshtunnel 모듈이 필요하다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">pip install pymysql</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">pip install sshtunnel</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">pip install paramiko</span></span><br></pre></td></tr></table></figure>

<h2 id="시나리오"><a href="#시나리오" class="headerlink" title="시나리오"></a>시나리오</h2><p>다음 2개의 시나리오는 참조 링크 <a href="#footnote3">3</a> 의 공식문서에 있는 내용이다.</p>
<p>사례1) 사용자가 8080 웹 서비스에 연결할 필요가 있을 때 22번 포트로만 연결가능할 때</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">                            |</span><br><span class="line">-------------+              |               +----------+</span><br><span class="line">    LOCAL    |              |               |  REMOTE  | :22 SSH</span><br><span class="line">    CLIENT   | &lt;== SSH ========&gt; |  SERVER  | :8080 web service</span><br><span class="line">-------------+              |               +----------+</span><br><span class="line">                            |</span><br><span class="line">                         FIREWALL (only port 22 is open)</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>사례2) SSH server 가 허용하는 경우.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">                            |</span><br><span class="line">-------------+              |    +----------+               +---------</span><br><span class="line">    LOCAL    |              |    |  REMOTE  |               | PRIVATE</span><br><span class="line">    CLIENT   | &lt;== SSH ========&gt; |  SERVER  | &lt;== local ==&gt; | SERVER</span><br><span class="line">-------------+              |    +----------+               +---------</span><br><span class="line">                            |</span><br><span class="line">                         FIREWALL (only port 443 is open)</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h2 id="DB접속-정보"><a href="#DB접속-정보" class="headerlink" title="DB접속 정보"></a>DB접속 정보</h2><p>sshtunnel 패키지를 사용한다. DB 접속 정보를 외부 json 파일에서 얻어온다고 가정한다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sqlalchemy <span class="keyword">as</span> sqla</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> text</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">ROOT_PATH = Path.home()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>( ROOT_PATH / Path(<span class="string">&#x27;.api_keys/secret_keys.json&#x27;</span>)) <span class="keyword">as</span> f:</span><br><span class="line">    secrets = json.loads(f.read())</span><br><span class="line"></span><br><span class="line">DB_USER, DB_PW = secrets[<span class="string">&#x27;lecture&#x27;</span>][<span class="string">&#x27;userid&#x27;</span>], secrets[<span class="string">&#x27;lecture&#x27;</span>][<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">SERVER24_USER, SERVER24_PW = secrets[<span class="string">&#x27;DBSERVER&#x27;</span>][<span class="string">&#x27;userid&#x27;</span>], secrets[<span class="string">&#x27;DBSERVER&#x27;</span>][<span class="string">&#x27;password&#x27;</span>]</span><br></pre></td></tr></table></figure>


<h2 id="SSHTunnelForwarder-사용"><a href="#SSHTunnelForwarder-사용" class="headerlink" title="SSHTunnelForwarder 사용"></a>SSHTunnelForwarder 사용</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SSHTunnelForwarder((HOST_IP, SSH_PORT),</span><br><span class="line">                    ssh_username=<span class="string">&#x27;USER_ID&#x27;</span>,</span><br><span class="line">                    ssh_pkey=<span class="string">&#x27;SSH_KEY&#x27;</span>,</span><br><span class="line">                    remote_bind_address=(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">3306</span>))</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ssh_address_or_host:</p>
<ul>
<li>tuple 형태나 string 형태로 설정할 수 있으며, 위와같이 키워드를 생략할 수 있습니다.</li>
<li>튜플형식: (호스트주소, 포트) 함께 정의</li>
<li>문자열 형식: 호스트 주소 설정 (ssh_port 키워드도 별도로 설정해줘야 합니다.)<ul>
<li><code>~/.ssh/config</code> 에 설정한 Host</li>
</ul>
</li>
</ul>
</li>
<li><p>ssh_port: ssh 서비스 포트</p>
</li>
<li><p>ssh_username: ssh 연결에 사용될 인증된 사용자</p>
</li>
<li><p>ssh_password: ssh 연결에 사용될 사용자의 접속 비밀번호<br>  보안을 위해 비밀번호를 설정하는 것보다는 private key을 사용하는 것을 권장합니다.</p>
</li>
<li><p>ssh_pkey: ssh 연결에 사용될 private key 파일 혹은 paramiko.pkey.PKey</p>
</li>
<li><p>remote_bind_address: <code>(호스트주소, 포트)</code> 튜플 형식. ssh 연결을 통해 접속한 원격 서버에서 접속할 private server 접속 정보.</p>
</li>
</ul>
<h3 id="with-구문과-사용"><a href="#with-구문과-사용" class="headerlink" title="with 구문과 사용"></a>with 구문과 사용</h3><p><code>SSHTunnelForwarder</code> 클래스에 <code>__enter__</code>, <code>__exit__</code> magic method가 정의되어 with 구문과 함께 사용한다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> sshtunnel.SSHTunnelForwarder(</span><br><span class="line">        (_host, _ssh_port),</span><br><span class="line">        ssh_username=_username,</span><br><span class="line">        ssh_password=_password,</span><br><span class="line">        remote_bind_address=(_remote_bind_address, _remote_mysql_port),</span><br><span class="line">        local_bind_address=(_local_bind_address, _local_mysql_port)</span><br><span class="line">) <span class="keyword">as</span> tunnel:</span><br><span class="line">    connection = mysql.connector.connect(</span><br><span class="line">        user=_db_user,</span><br><span class="line">        password=_db_password,</span><br><span class="line">        host=_local_bind_address,</span><br><span class="line">        database=_db_name,</span><br><span class="line">        port=_local_mysql_port)</span><br></pre></td></tr></table></figure>

<h3 id="Windows-경우-보안-경고를-확인"><a href="#Windows-경우-보안-경고를-확인" class="headerlink" title="Windows 경우 보안 경고를 확인!"></a>Windows 경우 보안 경고를 확인!</h3><p>윈도우즈에서 파이썬 코드에서 SSHTunnelForwarder 를 처음 사용시 아래 같이 경고를 만난다.</p>
<img src='/images/windows/windows-firewall-python-warning.png' width=500>

<h2 id="사례1"><a href="#사례1" class="headerlink" title="사례1"></a>사례1</h2><p>사례1 로 접속하는 방법이 전형적인 터널링 구현이다. SSHTunnelForwarder을 with 구문과 함께 쓸 수 있다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> sshtunnel <span class="keyword">import</span> SSHTunnelForwarder</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> SSHTunnelForwarder((<span class="string">&#x27;DBSERVER&#x27;</span>, <span class="number">2020</span>),</span><br><span class="line">                        ssh_username=SERVER24_USER,</span><br><span class="line">                        ssh_password=SERVER24_PW,</span><br><span class="line">                        remote_bind_address=(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">3306</span>), ) <span class="keyword">as</span> tunnel:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># connect MySQL like local</span></span><br><span class="line">    <span class="keyword">with</span> pymysql.connect(</span><br><span class="line">        host=<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="comment">#(local_host)</span></span><br><span class="line">        user=DB_USER,</span><br><span class="line">        passwd=DB_PW,</span><br><span class="line">        db=<span class="string">&#x27;lecture&#x27;</span>,</span><br><span class="line">        charset=<span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">        port=tunnel.local_bind_port, <span class="comment"># ssh로 접속한 클라이언트 포트</span></span><br><span class="line">        cursorclass=pymysql.cursors.DictCursor) <span class="keyword">as</span> conn:</span><br><span class="line">            <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cur:</span><br><span class="line">                sql = <span class="string">&quot;show tables;&quot;</span></span><br><span class="line">                cur.execute(sql)</span><br><span class="line">                <span class="built_in">print</span>(sql)</span><br><span class="line">                results = cur.fetchall()</span><br><span class="line">                <span class="built_in">print</span>(results)</span><br><span class="line">                <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">                    <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>

<p>터널링을 통해서 SQL Query가 잘 진행된다.</p>
<h2 id="사례2-ssh-pkey-사용-실패"><a href="#사례2-ssh-pkey-사용-실패" class="headerlink" title="사례2) ssh_pkey 사용 (실패)"></a>사례2) ssh_pkey 사용 (실패)</h2><blockquote>
<p>기록을 위해 남긴다. 잘 안되는 코드이다.</p>
</blockquote>
<p>사례2 같이 직접 서버에 접근이 안되는 경우  ssh key pair 를 사용할 수 있다.</p>
<p>사용자 아이디, 패스워드 형식에서 패스워드를 직접 코드 등에 입력하기 보다 private key 쌍을 사용하면 좀 더 보안에 안전하다.</p>
<p>ssh-keygen 으로 생성한 공개키를 DB 서버의 <code>ssh/authorized_keys`` 파일에 id_rsa.pub 내용을 </code>ssh-copy-id<code>또는</code>scp&#96; 명령으로 서버에 복사한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ssh-copy-id -i ~/.ssh/id_rsa.pub username@jump_server_host -p ssh_port</span></span><br></pre></td></tr></table></figure>


<p>scp 를 사용해도 좋다</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">scp -P 2020 .\.ssh\id_rsa qkboo@DBSERVER:~/auth_key</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">복사한 공개키를 `.ssh/authorized_keys` 에 추가한다.</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">cat</span> auth_key &gt;&gt; .ssh/authorized_keys</span></span><br></pre></td></tr></table></figure>


<p>SSHTunnelForwarder 에서 ssh_pkey 에 비밀키를 지정해 준다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> SSHTunnelForwarder((<span class="string">&#x27;DBSERVER&#x27;</span>, <span class="number">2020</span>),</span><br><span class="line">                        ssh_username=<span class="string">&#x27;qkboo&#x27;</span>,</span><br><span class="line">                        ssh_pkey=<span class="string">&#x27;~/.ssh/id_rsa&#x27;</span>,</span><br><span class="line">                        remote_bind_address=(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">3306</span>)) <span class="keyword">as</span> tunnel:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>( tunnel.ssh_host_key )</span><br><span class="line">    <span class="built_in">print</span>( tunnel.local_bind_address )</span><br><span class="line">    <span class="built_in">print</span>( tunnel._remote_binds )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># connect MySQL like local</span></span><br><span class="line">    <span class="keyword">with</span> pymysql.connect(</span><br><span class="line">        host=<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="comment">#(local_host)</span></span><br><span class="line">        user=<span class="string">&#x27;user1&#x27;</span>,</span><br><span class="line">        passwd=<span class="string">&#x27;012345&#x27;</span>,</span><br><span class="line">        db=<span class="string">&#x27;lecture&#x27;</span>,</span><br><span class="line">        charset=<span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">        port=<span class="number">3306</span>,</span><br><span class="line">        <span class="comment"># port=tunnel.local_bind_port,</span></span><br><span class="line">        cursorclass=pymysql.cursors.DictCursor) <span class="keyword">as</span> conn:</span><br><span class="line">            <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cur:</span><br><span class="line">                sql = <span class="string">&quot;show tables;&quot;</span></span><br><span class="line">                cur.execute(sql)</span><br><span class="line">                <span class="built_in">print</span>(sql)</span><br><span class="line">                results = cur.fetchall()</span><br><span class="line">                <span class="built_in">print</span>(results)</span><br><span class="line">                <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">                    <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>

<h2 id="SQLAlchemy-engine-생성하기"><a href="#SQLAlchemy-engine-생성하기" class="headerlink" title="SQLAlchemy engine 생성하기"></a>SQLAlchemy engine 생성하기</h2><p>SQLAlchemy 의 engine 을 생성할 수 있다. with 구문과 함께 사용할 수 있지만 engine 을 여러 프로시저에서 지속해서 사용한다면 아래 같이 start(), stop() 사이에 pymysql, sqlalchemy  코드를 배치해도 좋다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SSH Tunnel 사용1</span></span><br><span class="line"><span class="keyword">from</span> sshtunnel <span class="keyword">import</span> SSHTunnelForwarder</span><br><span class="line"></span><br><span class="line">server = SSHTunnelForwarder((<span class="string">&#x27;DBSERVER&#x27;</span>, <span class="number">2020</span>),</span><br><span class="line">                        ssh_username=SERVER24_USER,</span><br><span class="line">                        ssh_password=SERVER24_PW,</span><br><span class="line">                        remote_bind_address=(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">3306</span>), )</span><br><span class="line">server.start() <span class="comment"># Tunnel 시작</span></span><br><span class="line"></span><br><span class="line">local_port = <span class="built_in">str</span>(server.local_bind_port)</span><br><span class="line">engine = sqla.create_engine(<span class="string">f&#x27;mysql+pymysql://<span class="subst">&#123;DB_USER&#125;</span>:<span class="subst">&#123;DB_PW&#125;</span>@127.0.0.1:<span class="subst">&#123;local_port&#125;</span>/bookstore&#x27;</span>)</span><br><span class="line">query = <span class="string">&quot;&quot;&quot;SELECT * FROM book;&quot;&quot;&quot;</span></span><br><span class="line">df = pd.read_sql(sqla.text(query), con=engine)</span><br><span class="line">engine.dispose()</span><br><span class="line"></span><br><span class="line">server.stop() <span class="comment"># Tunnel 종료</span></span><br></pre></td></tr></table></figure>

<p>with 구문과 사용</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SSH Tunnel 사용2 - with 구문과 사용</span></span><br><span class="line"><span class="keyword">with</span> SSHTunnelForwarder((<span class="string">&#x27;192.168.0.24&#x27;</span>, <span class="number">2020</span>),</span><br><span class="line">                        ssh_username=SERVER24_USER,</span><br><span class="line">                        ssh_password=SERVER24_PW,</span><br><span class="line">                        remote_bind_address=(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">3306</span>), ) <span class="keyword">as</span> tunnel:</span><br><span class="line">    </span><br><span class="line">    local_port = <span class="built_in">str</span>(tunnel.local_bind_port)</span><br><span class="line">    engine = sqla.create_engine(<span class="string">f&#x27;mysql+pymysql://<span class="subst">&#123;DB_USER&#125;</span>:<span class="subst">&#123;DB_PW&#125;</span>@127.0.0.1:<span class="subst">&#123;local_port&#125;</span>/bookstore&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    query = <span class="string">&quot;&quot;&quot;SELECT * FROM book;&quot;&quot;&quot;</span></span><br><span class="line">    df_sector = pd.read_sql(sqla.text(query), con=engine)</span><br><span class="line">    engine.dispose()</span><br></pre></td></tr></table></figure>


<br>

<h1 id="클라이언트에서-ssh-tunnel-사용"><a href="#클라이언트에서-ssh-tunnel-사용" class="headerlink" title="클라이언트에서 ssh tunnel 사용"></a>클라이언트에서 ssh tunnel 사용</h1><p>클라이언트에서 MySQL &#x2F; MariaDB 접속시 보안을 위해서 SSH over 방식을 통해 3306 포트가 아닌 ssh over 방법을 사용할 수 있다.</p>
<ol>
<li>HeidiSQL ssh tunnel 사용하기</li>
<li>MysQL Workbench 에서 ssh tunnel 사용하기</li>
<li>Server 에서 bind 제외하기</li>
</ol>
<h2 id="1-HeidiSQL-ssh-tunnel-사용하기"><a href="#1-HeidiSQL-ssh-tunnel-사용하기" class="headerlink" title="1. HeidiSQL ssh tunnel 사용하기"></a>1. HeidiSQL ssh tunnel 사용하기</h2><p>유형을 SSH Tunnel 로 선택하고 MySQL &#x2F; MariaDB 데이터베이스의 DB 사용자 계정과 비밀번호을 입력한다.</p>
<img src='/images/database/sshtunnel_heidisql1.png' width=550>

<p>SSH tunnel 을 만들어줄 ssh client 를 선택하고 개인 키 파일을 선택한다.  SSH 로 로그인하는 DB server의 사용자 계정 ID를 입력한다. </p>
<img src='/images/database/sshtunnel_heidisql2.png' width=550>

<p>선택한  개인 키가 로그인 패스워드를 대체한다.</p>
<blockquote>
<p>SSH 아이디-패스워드 방법은 잘 안된다.</p>
</blockquote>
<h2 id="2-MysQL-Workbench-에서-ssh-tunnel-사용하기"><a href="#2-MysQL-Workbench-에서-ssh-tunnel-사용하기" class="headerlink" title="2. MysQL Workbench 에서 ssh tunnel 사용하기"></a>2. MysQL Workbench 에서 ssh tunnel 사용하기</h2><p>MySQL workbench 에서 ssh tunnel 로 접속하려면 DB 서버측에 authorized_keys 에 클라이언트 공개키가 등록되어야 한다.</p>
<p>DB 서버의 &#96;ssh&#x2F;authorized_keys&#96;&#96; 파일에 id_rsa.pub 내용을 추가한다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; scp -P 2020 .\.ssh\id_rsa qkboo@192.168.0.24:~/auth_key</span><br></pre></td></tr></table></figure>

<p>복사한 공개키를 <code>.ssh/authorized_keys</code> 에 추가한다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat auth_key &gt;&gt; .ssh/authorized_keys</span><br></pre></td></tr></table></figure>

<img src='/images/database/sshtunnel_workbench1.png' width=550>

<blockquote>
<p>root 계정은 잘 안된다.</p>
</blockquote>
<h2 id="3-Server-에서-bind-제외하기"><a href="#3-Server-에서-bind-제외하기" class="headerlink" title="3. Server 에서 bind 제외하기"></a>3. Server 에서 bind 제외하기</h2><p>서버에서 my.cnf 에 bind를 <code>0.0.0.0</code> 으로 해두었으면 기본 값인 <code>127.0.0.1</code>로 해두고 SSH tunnel 방법으로 통해 접근하므로 좀 더 안전할 수 있다.</p>
<ul>
<li>DB server 로컬에서는 직접 mysql client 로 접근가능하고</li>
<li>외부 &#x2F; 원격지에서는 ssh tunnel 을 통해서 작업이 가능하다.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind-address  = 127.0.0.1</span><br></pre></td></tr></table></figure>



<hr>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ol>
<li><a name='footnote1'>참고1</a> : <a target="_blank" rel="noopener" href="https://blog.jiniworld.me/124">MySQL SSH Tunnel 소개, blog</a></li>
<li><a name='footnote2'>참고2 - SSH Tunneling</a> : <a target="_blank" rel="noopener" href="https://www.ssh.com/academy/ssh/tunneling">SSH Tunnel 이란</a></li>
<li><a name='footnote3'>참고3</a> : <a target="_blank" rel="noopener" href="https://sshtunnel.readthedocs.io/en/latest/">sshtunnel docs</a></li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-16T16:00:00.000Z" title="7/17/2023, 1:00:00 AM">2023-07-17</time>&nbsp;게시 됨</span><span class="level-item"><time dateTime="2023-07-17T07:21:58.093Z" title="7/17/2023, 4:21:58 PM">2023-07-17</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Database/">Database</a></span><span class="level-item">3분안에 읽기 (약 427 단어)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/mariadb-enable_tls_3-9959269a57dd/">MariaDB 클라언트-서버 TLS/SSL 암호화 연결(3)</a></p><div class="content"><p>MySQL &#x2F; MariaDB 에 TLS 를 활성화 하고 클라이언트를 사용시 몇 가지 사례를 살펴본다.</p>
<p>글 타래:</p>
<ol>
<li><a href="/mariadb-enable_tls_1-50b5d39df89f/">MariaDB 클라언트-서버 TLS&#x2F;SSL 암호화 연결(1)</a></li>
<li><a href="/mariadb-enable_tls_2-client-4b6a88c2e5be/">MariaDB 클라언트-서버 TLS&#x2F;SSL 암호화 연결(2)</a></li>
<li>MariaDB 클라언트-서버 TLS&#x2F;SSL 암호화 연결(3)</li>
</ol>
<p>글 진행 순서:</p>
<ol>
<li>Grant 와 SSL 사용</li>
</ol>
<br>

<h1 id="1-Grant-와-SSL-사용"><a href="#1-Grant-와-SSL-사용" class="headerlink" title="1. Grant 와 SSL 사용"></a>1. Grant 와 SSL 사용</h1><p>GRANT 로 어떤 사용자에게 SSL 을 필수로 지정한다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> freedb.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;USERID&#x27;</span>@<span class="string">&#x27;%&#x27;</span> require ssl;</span><br></pre></td></tr></table></figure>

<p>결과적으로 USERID 가 freedb 에서 허용된 권한은 다음 같다</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;USERID&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> `USERID`@`<span class="operator">%</span>` IDENTIFIED <span class="keyword">BY</span> PASSWORD <span class="string">&#x27;*0F5BEAE3607A82096C813BBE86B0BD7F91BD7339&#x27;</span> REQUIRE SSL <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> `freedb`.<span class="operator">*</span> <span class="keyword">TO</span> `USERID`@`<span class="operator">%</span>` <span class="operator">|</span></span><br></pre></td></tr></table></figure>

<p>이 계정에 주어진 SSL 필수 권한 상태에서 MySQL Workbench로 SSl 을 강제로 끄고 연결해 보자.</p>
<img src='/images/database/workbench-ssl_test-1.png' width=550>

<p>SSL을 연결하지 않고 접속하면 접근을 막는 것을 확인할 수 있다.</p>
<img src='/images/database/workbench-ssl_test-2.png' width=350>


<h1 id="2-TLS-세션-확인"><a href="#2-TLS-세션-확인" class="headerlink" title="2. TLS 세션 확인"></a>2. TLS 세션 확인</h1><p>mysqlclient, MySQLworkbench 혹은 Python&#x2F;C&#x2F;Java 등에서 DBI 인터페이스로 SSL 을 연결하고 SQL 을 실행한다. 이때 접속한 세션이 TLS 상태로 연결됐는지를 확인할 수 있다. </p>
<p>접속한 클라이언트에서 아래 SQL 로 <code>Ssl_cipher</code> 를 검색해보면 현재 세션이 TLS 상태인지를 확인이 가능하다. 빈 결과가 나오면 평문 TCP&#x2F;IP 으로 접속되 것이다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> <span class="keyword">show</span> session status <span class="keyword">like</span> <span class="string">&#x27;Ssl_cipher&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------------------+</span></span><br><span class="line"><span class="operator">|</span> Ssl_cipher    <span class="operator">|</span> TLS_AES_256_GCM_SHA384 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.006</span> sec)</span><br></pre></td></tr></table></figure>


<h1 id="—"><a href="#—" class="headerlink" title="—"></a>—</h1><ol>
<li><a name='footnote1'>참고1</a> : <a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/securing-connections-for-client-and-server/#verifying-that-a-connection-is-using-tls">Verifying that a Connection is Using TLS</a></li>
<li><a name='footnote2'>참고2</a> : <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/mysql-security-excerpt/8.0/en/using-encrypted-connections.html">Configuring MySQL to Use Encrypted Connections</a></li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-16T10:00:00.000Z" title="7/16/2023, 7:00:00 PM">2023-07-16</time>&nbsp;게시 됨</span><span class="level-item"><time dateTime="2023-07-16T16:38:17.264Z" title="7/17/2023, 1:38:17 AM">2023-07-17</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Database/">Database</a></span><span class="level-item">9분안에 읽기 (약 1413 단어)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/mariadb-enable_tls_2-client-4b6a88c2e5be/">MariaDB 클라언트-서버 TLS/SSL 암호화 연결(2)</a></p><div class="content"><p>MariaDB 클라언트-서버 TLS&#x2F;SSL 클라이언트 사용</p>
<p>글 타래:</p>
<ol>
<li><a href="/mariadb-enable_tls_1-50b5d39df89f/">MariaDB 클라언트-서버 TLS&#x2F;SSL 암호화 연결(1)</a></li>
<li>MariaDB 클라언트-서버 TLS&#x2F;SSL 암호화 연결(2)</li>
<li><a href="/mariadb-enable_tls_3-bdcd5755b87e/">MariaDB 클라언트-서버 TLS&#x2F;SSL 암호화 연결(3)</a></li>
</ol>
<p>서버측에서 MariaDB&#x2F;MySQL 의 TLS를 활성화한 다음 실제 다양한 클라이언트에서 접속을 시도해 보자. 서버에서 생성한 CA 파일 ca.pem, 클라이언트 인증서 client-ssl.pem, 클라이언트 키 client-key.pem 을 다운로드해서 사용한다.</p>
<p>글 진행 순서</p>
<ol>
<li>클라이언트 인증서 다운로드</li>
<li>DB API: python 에서 SSL 접속</li>
<li>HeidiSQL 에서 SSL 접속</li>
<li>MySQL Workbench 에서 SSL 접속</li>
</ol>
<h1 id="1-클라이언트-인증서-다운로드"><a href="#1-클라이언트-인증서-다운로드" class="headerlink" title="1. 클라이언트 인증서 다운로드"></a>1. 클라이언트 인증서 다운로드</h1><p>앞서 <a href="/mariadb-enable_tls_1-50b5d39df89f/">MariaDB 클라언트-서버 TLS&#x2F;SSL 암호화 연결(1)</a> 만든 ca.pem, client-cert.pem, client-key.pem 을 외부접속할 클라이언트 PC로 다운받는다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">mkdir</span> .ssl/mysql/</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">cd</span> .ssl/mysql</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">다운로드</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">scp -P 2020 USERID@HOST_IP:/etc/ssl/mysql/ca.pem .</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">scp -P 2020 USERID@HOST_IP:/etc/ssl/mysql/client-ssl.pem .</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">scp -P 2020 USERID@HOST_IP:/etc/ssl/mysql/client-key.pem .</span></span><br></pre></td></tr></table></figure>

<p>다운로드한 파일은 3종류로</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">ls</span> .ssl/mysql</span></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">-a---        2023-07-16  오후 4:38           1984 ca.pem</span><br><span class="line">-a---        2023-07-16  오후 4:38           1497 client-cert.pem</span><br><span class="line">-a---        2023-07-16  오후 4:38           1679 client-key.pem</span><br></pre></td></tr></table></figure>

<blockquote>
<p>서버와 비슷하게 mysql client 설정에 인증키들을 설정해주면 그냥 접속해도 ssl로 접속된다. 아래 <a href="#footnote2">참고2</a> 에서 mysql client 의 클라이언트 측 my.cnf&#x2F;my.ini 파일에 ssl-ca, ssl-cert, ssl-key 를 설정하면 된다.</p>
</blockquote>
<h1 id="2-DB-API-python-에서-SSL-접속"><a href="#2-DB-API-python-에서-SSL-접속" class="headerlink" title="2. DB API: python 에서 SSL 접속"></a>2. DB API: python 에서 SSL 접속</h1><p>pymysql, sqlalchemy 등 mysql client API 에 ssl_ca, ssl_key, ssl_cert 인자에 클라이언트용 인증 파일을 연결한다.</p>
<h3 id="pymysql"><a href="#pymysql" class="headerlink" title="pymysql"></a>pymysql</h3><p>pymysql.connect 에 ssl_ca, ssl_key, ssl_cert 인자 클라이언트용 인증 파일의 경로가 SSL_CA, SSL_CERT, SSL_KEY 에 있다고 가정한다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">conn = pymysql.connect(host=<span class="string">&#x27;192.168.0.10&#x27;</span>, </span><br><span class="line">                       user=DB_USER, </span><br><span class="line">                       password=DB_PW,</span><br><span class="line">                       db=<span class="string">&#x27;bookstore&#x27;</span>, </span><br><span class="line">                       ssl_ca=SSL_CA,</span><br><span class="line">                       ssl_key=SSL_KEY,</span><br><span class="line">                       ssl_cert=SSL_CERT,</span><br><span class="line">                       charset=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Connection 으로부터 Cursor 생성</span></span><br><span class="line">curs = conn.cursor()</span><br><span class="line">sql = <span class="string">&quot;select * from book&quot;</span></span><br><span class="line">curs.execute(sql)</span><br><span class="line">rows = curs.fetchall()</span><br><span class="line"><span class="built_in">print</span>(rows)     <span class="comment"># 전체 rows</span></span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>


<h3 id="SQLAlchemy-engine"><a href="#SQLAlchemy-engine" class="headerlink" title="SQLAlchemy : engine"></a>SQLAlchemy : engine</h3><p>sqlalchemy의 create_engin에 <code>connect_args</code> 인자에 클라이언트 인증 파일의 경로가 SSL_CA, SSL_CERT, SSL_KEY 에 있다고 가정한다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ssl_args = &#123;<span class="string">&#x27;ssl_ca&#x27;</span>: SSL_CA,</span><br><span class="line">           <span class="string">&#x27;ssl_cert&#x27;</span>: SSL_CERT,</span><br><span class="line">           <span class="string">&#x27;ssl_key&#x27;</span>: SSL_KEY&#125;</span><br><span class="line">engine = sqla.create_engine(</span><br><span class="line">    <span class="string">f&#x27;mysql+pymysql://<span class="subst">&#123;DB_USER&#125;</span>:<span class="subst">&#123;DB_PW&#125;</span>@192.168.0.24/bookstore&#x27;</span>,</span><br><span class="line">    connect_args=ssl_args)</span><br><span class="line"></span><br><span class="line">query = <span class="string">&quot;&quot;&quot;SELECT * FROM book;&quot;&quot;&quot;</span></span><br><span class="line">df = pd.read_sql(sqla.text(query), con=engine)</span><br></pre></td></tr></table></figure>


<h3 id="C-라이브러리-사용-SSL-접속"><a href="#C-라이브러리-사용-SSL-접속" class="headerlink" title="C 라이브러리 사용 SSL 접속"></a>C 라이브러리 사용 SSL 접속</h3><p><a href="#footnote2">참고2</a> 를 보면 C API를 사용한 <u><em>&#96;libmariadb.dll&#96;&#96; 라이브러리에서 SSL 사용하는 C++ 콘솔 예제</em></u> 가 있다.</p>
<br>

<h1 id="3-HeidiSQL-에서-SSL-접속"><a href="#3-HeidiSQL-에서-SSL-접속" class="headerlink" title="3. HeidiSQL 에서 SSL 접속"></a>3. HeidiSQL 에서 SSL 접속</h1><p>HeidiSQL 에서 SSL 을 이용해 접속할 수 있다. 아래 그림 같이 DB 정보를 입력한 후에 SSL 탭에서 SSL을 체크만 하면 된다.</p>
<img src='/images/database/heidisql_ssl1.png' width=500>

<p>접속이 되면 프로그램 아래 상태바의 정보를 클릭해 보면 SSL 연결을 확인할 수 있다.</p>
<img src='/images/database/heidisql_ssl3.png' width=300>


<p>앞서 다운로드한 서버측이 제고한 클라이언트 인증 키를 지정하고 연결하면 아래 같은 cipher mis match 에러가 뜬다.</p>
<img src='/images/database/heidisql_ssl2.png' width=300>

<p>이것은 아마도 서버측의 openssl.cnf 에 정의되어 있는 CipherString 버전이 달라서 그런것 같다. 여기 <a target="_blank" rel="noopener" href="https://jira.mariadb.org/browse/CONC-527">Connect error “SEC_E_ALGORITHM_MISMATCH”..</a> 의 글타래에 설명되어 있다. </p>
<ul>
<li>테스트한 서버는 ** Armbian 23.02.2 Bullseye** 로 CipherString 이 <code>DEFAULT@SECLEVEL=2</code> 로 나온다.</li>
</ul>
<h3 id="TLS-versions"><a href="#TLS-versions" class="headerlink" title="TLS versions"></a>TLS versions</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;tls_version&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------------------------+</span></span><br><span class="line"><span class="operator">|</span> tls_version   <span class="operator">|</span> TLSv1<span class="number">.1</span>,TLSv1<span class="number">.2</span>,TLSv1<span class="number">.3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.007</span> sec)</span><br></pre></td></tr></table></figure>


<h3 id="CipherString-테스트"><a href="#CipherString-테스트" class="headerlink" title="CipherString 테스트"></a>CipherString 테스트</h3><p>MySQL 설정파일 <a href="#footnote3">참조3</a>에 따르면 <em>server-side encrypted-connection control</em> 을 위해서 아래 변수를 사용할 수 있다고 한다.</p>
<figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl_cipher</span>: The list of permissible ciphers for connection encryption.</span><br></pre></td></tr></table></figure>

<p>my.cnf 의  SSL&#x2F;TLS 영역 다음을 추가해 보자.</p>
<figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl_cipher</span>=DEFAULT:@SECLEVEL=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>재시작한후 아래 그림 같이 서버에서 만든 클라이언트 인증서를 사용해보니 잘 된다. root 계정 접속도 잘 된다.</p>
<img src='/images/database/heidisql_ssl4.png' width=500>





<br>


<h1 id="4-MySQL-Workbench-에서-SSL-접속"><a href="#4-MySQL-Workbench-에서-SSL-접속" class="headerlink" title="4. MySQL Workbench 에서 SSL 접속"></a>4. MySQL Workbench 에서 SSL 접속</h1><p>MySQL Workbench 에서도 SSL 연결로 데이터베이스에 접속할 수 있다. DB 접속 계정 정보를 입력한다.</p>
<img src='/images/database/mysqlworkbench_ssl1.png' width=500>

<p>SSL 탭에서 SSL 관련 옵션을 선택하는데 여기서는 if available 로 지정했다. 서버측이 SSL활성화가 되어 있으면 자동으로 SSL 통신을 진행한다.</p>
<img src='/images/database/mysqlworkbench_ssl2.png' width=500>

<p>Test 로 확인해 보면 SSL 접속이 잘 되고 있는 것을 알 수 있다.</p>
<img src='/images/database/mysqlworkbench_ssl3.png' width=300>





<h1 id="5-사용자-SSL-권한-부여"><a href="#5-사용자-SSL-권한-부여" class="headerlink" title="5. 사용자 SSL 권한 부여"></a>5. 사용자 SSL 권한 부여</h1><p>새 사용자를 생성할 때 아래 같이 접속시 <code>REQUIRE</code> 인자로 SSL 로만 접속하도록 할 수 있다.  </p>
<blockquote>
<p>사용자의 추가&#x2F;권한 부여에 대해서 <a href="/mysql-admin-cli-c4134cfe1788/#User-amp-Privileges">MySQL CLI&#x2F;Admin: 권한부여</a> 글을 참고.</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># SSL<span class="operator">/</span>TLS(가장 기본적인 암호화 접속)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;********&#x27;</span> REQUIRE SSL;</span><br><span class="line"></span><br><span class="line"># X509</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;********&#x27;</span> REQUIRE X509;</span><br><span class="line"></span><br><span class="line"># CIPHER <span class="string">&#x27;cipher&#x27;</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;********&#x27;</span> REQUIRE CIPHER <span class="string">&#x27;EDH-RSA-DES-CBC3-SHA&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> flush privileges;</span><br></pre></td></tr></table></figure>
<p>기존 사용자는 사용자 권한에서 SSL을 권한을 추가한다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> DB이름.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;USERID&#x27;</span>@<span class="string">&#x27;%&#x27;</span> REQUIRE SSL;</span><br><span class="line">mysql<span class="operator">&gt;</span> flush privileges;</span><br></pre></td></tr></table></figure>

<p>주어진 grant에 SSL&#x2F;X509 등이 주어졌는지 확인한다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;USERID&#x27;</span>@<span class="string">&#x27;HOST&#x27;</span>;</span><br></pre></td></tr></table></figure>


<p>내부 네트워크 외부 네트워크로 분리해 사용한다면 외부에서는 무조건 SSL 을 사용하도록 할 수 있을 것 같다.</p>
<h1 id="—"><a href="#—" class="headerlink" title="—"></a>—</h1><ol>
<li><a name='footnote1'>참고1</a> : <a target="_blank" rel="noopener" href="https://susoterran.github.io/mysql/mysql_privatecertificate/">OpenSSL을 이용한 사설 인증서 생성</a></li>
<li><a name='footnote2'>참고2</a> : <a target="_blank" rel="noopener" href="https://ddart.net/xe/board/12867">MariaDB 외부접속시 ssl 사용법, 그리고 ssl 로 replication(동기화) 하기</a></li>
<li><a name='footnote3'>참고3</a> : <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/mysql-security-excerpt/8.0/en/using-encrypted-connections.html">Configuring MySQL to Use Encrypted Connections</a></li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-16T00:00:00.000Z" title="7/16/2023, 9:00:00 AM">2023-07-16</time>&nbsp;게시 됨</span><span class="level-item"><time dateTime="2024-03-04T21:10:57.453Z" title="3/5/2024, 6:10:57 AM">2024-03-05</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Database/">Database</a></span><span class="level-item">13분안에 읽기 (약 1943 단어)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/mariadb-enable_tls_1-50b5d39df89f/">MariaDB 클라언트-서버 TLS/SSL 암호화 연결(1)</a></p><div class="content"><p>MySQL &#x2F; MaraiDB 서버에 TLS 를 활성화 해서 암호화 통신을 할 수 있다. MySQL (MariaDB도 동일함)에서는 서버-클라이언트 사이에 전송되는 데이터를 TLS (이전 SSL) 프로토콜을 이용하여 암호화하여 DB 정보가 노출되지 않게 방지할 수 있다. SSL을 통해서 Replication Master - Slave 도 가능하다.</p>
<p>글 타래:</p>
<ol>
<li>MariaDB 클라언트-서버 TLS&#x2F;SSL 암호화 연결(1)</li>
<li><a href="/mariadb-enable_tls_2-client-4b6a88c2e5be/">MariaDB 클라언트-서버 TLS&#x2F;SSL 암호화 연결(2)</a></li>
<li><a href="/mariadb-enable_tls_3-bdcd5755b87e/">MariaDB 클라언트-서버 TLS&#x2F;SSL 암호화 연결(3)</a></li>
</ol>
<p>글 진행 순서:</p>
<ol>
<li>사설 CA  인증서 생성</li>
<li>클라이언트 인증서 생성</li>
<li>사설 CA  인증서 설정</li>
</ol>
<br>

<h1 id="시스템-사양"><a href="#시스템-사양" class="headerlink" title="시스템 사양"></a>시스템 사양</h1><ol>
<li>Armbian 23.8.1 Bullseye &#x2F; mariadb-server-10.5</li>
</ol>
<h1 id="1-사설-CA-인증서-생성"><a href="#1-사설-CA-인증서-생성" class="headerlink" title="1. 사설 CA  인증서 생성"></a>1. 사설 CA  인증서 생성</h1><p>openssl을 사용해서 ssl_cert, ssl_key, ssl_ca 에 사용하는 서버용 사설 인증서를 생성한다. </p>
<blockquote>
<p>openssl을 이용한 사설 인증서 생성에 대해서는 <a href="20230428-HTTPS_Private_SSL-4271241fb2d7/">HTTPS 를 위한 Private SSL</a> 기사도 참조할 수 있다.<br><br><br>이 글에서는 아래 <a href="#footnote1">참고1</a>, <a href="#footnote2">참고2</a> 를 적용했다.</p>
</blockquote>
<p>인증서는 사설 CA(Certificate Authority)용 인증서, 서버용, 클라이언트용 총 3가지를 만든다. </p>
<h2 id="인증서-저장-위치-생성"><a href="#인증서-저장-위치-생성" class="headerlink" title="인증서 저장 위치 생성"></a>인증서 저장 위치 생성</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo mkdir /etc/ssl/mysql</span><br><span class="line">(SERVER) $ cd /etc/ssl/mysql</span><br></pre></td></tr></table></figure>

<p>생성한 TLS 인증서는 MySQL&#x2F;MariaDB 의 my.cnf 설정파일의 변수를 3가지 설정한다.</p>
<ul>
<li><code>ssl_cert</code> 시스템 변수: 서버 인증서(X509) 경로 지정</li>
<li><code>ssl_key</code> 시스템 변수: 서버 개인키 경로 지정</li>
<li><code>ssl_ca</code> 혹은 ssl_capath 시스템 변수: Self-signed CA certificate CA 키 경로</li>
</ul>
<h2 id="openssl-사설-CA-인증서-생성"><a href="#openssl-사설-CA-인증서-생성" class="headerlink" title="openssl 사설 CA 인증서 생성"></a>openssl 사설 CA 인증서 생성</h2><p>저장 위치 <code>/etc/ssl/mysql</code> 에서  관리용 CA 인증서 생성한다. </p>
<p>먼저 openssl에서 rsa 알고리즘으로 4096 크기 비밀키를 생성한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo openssl genrsa -out ca-key.pem 4096</span><br><span class="line">Generating RSA private key, 4096 bit long modulus (2 primes)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>비밀키 파일 ca-key.pem 파일을 사용해서 CA인증서 ca.pem 파일로 생성한다. 비밀키로 CA를 위한  CSR(certificate signing request) 과정을 거쳐 ca.pem 을 생성해9서 필요한 인증서 정보를 묻는다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo openssl req -new -x509 -nodes -days 365000 -key ca-key.pem -out ca.pem</span><br><span class="line">...</span><br><span class="line">Country Name (2 letter code) [AU]: KR</span><br><span class="line">State or Province Name (full name) [Some-State]:Seoul</span><br><span class="line">Locality Name (eg, city) []:</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:YOUR company</span><br><span class="line">Organizational Unit Name (eg, section) []: Administration</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []::mysql-admin.DOMAIN.name</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure>

<p>현재까지</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ ls -l</span><br><span class="line">-rw------- 1 root root 3243 Jul 16 15:04 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1972 Jul 16 15:11 ca.pem</span><br></pre></td></tr></table></figure>


<h2 id="서버-인증서-생성"><a href="#서버-인증서-생성" class="headerlink" title="서버 인증서 생성"></a>서버 인증서 생성</h2><p>서버용 인증서 생성한다. 단, openssl 명령 과정에서 <strong>Common Name</strong> 을 3가지 모두 다르게 해야 검증오류를 피할 수 있다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo openssl req -newkey rsa:4096 -days 365000 -nodes -keyout server-key.pem -out server-req.pem</span><br><span class="line"></span><br><span class="line">Country Name (2 letter code) [AU]:KR</span><br><span class="line">State or Province Name (full name) [Some-State]:Seoul</span><br><span class="line">Locality Name (eg, city) []:</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:YOUR company</span><br><span class="line">Organizational Unit Name (eg, section) []:Administration</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:server.DOMAIN.name</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">Please enter the following &#x27;extra&#x27; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>현재 디렉토리</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ ls -l</span><br><span class="line">-rw------- 1 root root 3243 Jul 16 15:04 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1972 Jul 16 15:11 ca.pem</span><br><span class="line">-rw------- 1 root root 3272 Jul 16 15:15 server-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1704 Jul 16 15:16 server-req.pem</span><br></pre></td></tr></table></figure>

<p>RSA 알고리즘으로 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo openssl rsa -in server-key.pem -out server-key.pem</span><br><span class="line">writing RSA key</span><br></pre></td></tr></table></figure>

<p>CA 비밀키 ca-key.pem 를 사용해  X509 인증서를 사이닝한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo openssl x509 -req -in server-req.pem -days 365000 -CA ca.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem</span><br><span class="line">Signature ok</span><br><span class="line">subject=C = KR, ST = Seoul, O = Thinkbee company, OU = Administration, CN = admin.thinkbee.kr</span><br><span class="line">Getting CA Private Key</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo openssl verify -CAfile ca.pem server-cert.pem</span><br><span class="line">server-cert.pem: OK</span><br></pre></td></tr></table></figure>

<p>현재 디렉토리</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ ls -l</span><br><span class="line">-rw------- 1 root root 3243 Jul 16 15:04 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1972 Jul 16 15:11 ca.pem</span><br><span class="line">-rw-r--r-- 1 root root 1862 Jul 16 15:20 server-cert.pem</span><br><span class="line">-rw------- 1 root root 3243 Jul 16 15:19 server-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1704 Jul 16 15:16 server-req.pem</span><br></pre></td></tr></table></figure>


<br>


<h1 id="2-클라이언트-인증서-생성"><a href="#2-클라이언트-인증서-생성" class="headerlink" title="2. 클라이언트 인증서 생성"></a>2. 클라이언트 인증서 생성</h1><p>클라이언트 인증서는 다음과 같은 용도로 사용한다.  단, openssl 명령 과정에서 <strong>Common Name</strong> 을 3가지 모두 다르게 해야 검증오류를 피할 수 있다.</p>
<ul>
<li>DB 서버와 별도로 존재하는 웹 서버에서 DB 서버로 SSL 통신을 할 때 웹 서버에 적용</li>
<li>접속하고자 하는 DB 서버와 별도의 리눅스 환경에서 mysql 클라이언트 프로그램으로 DB 서버에 접속할 때 클라이언트에 적용</li>
<li>Replication 에서 Master와 Slave 간의 SSL 통신을 하고자 할 때 Slave 서버에 적용</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo openssl req -newkey rsa:2048 -days 365000 -nodes -keyout client-key.pem -out client-req.pem</span><br><span class="line">Country Name (2 letter code) [AU]:KR</span><br><span class="line">State or Province Name (full name) [Some-State]:Seoul</span><br><span class="line">Locality Name (eg, city) []:</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:</span><br><span class="line">Organizational Unit Name (eg, section) []:</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []::mysql-client.thinkbee.kr</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo openssl rsa -in client-key.pem -out client-key.pem</span><br><span class="line">writing RSA key</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo openssl x509 -req -in client-req.pem -days 365000 -CA ca.pem -CAkey ca-key.pem -set_serial 01 -out client-cert.pem</span><br><span class="line">Signature ok</span><br><span class="line">subject=C = KR, ST = Seoul, O = Internet Widgits Pty Ltd, CN = client-thinkbee.kr</span><br><span class="line">Getting CA Private Key</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo openssl verify -CAfile ca.pem client-cert.pem </span><br><span class="line">client-cert.pem: OK</span><br></pre></td></tr></table></figure>

<p>현재 디렉토리를 접근 권한을 조정한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ sudo chown mysql.mysql *.*</span><br><span class="line">(SERVER) $ ls -l</span><br><span class="line">-rw-r--r-- 1 mysql mysql 3243  7월 16 15:43 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 mysql mysql 1984  7월 16 15:46 ca.pem</span><br><span class="line">-rw-r--r-- 1 mysql mysql 1497  7월 16 15:51 client-cert.pem</span><br><span class="line">-rw-r--r-- 1 mysql mysql 1679  7월 16 15:51 client-key.pem</span><br><span class="line">-rw-r--r-- 1 mysql mysql  989  7월 16 15:50 client-req.pem</span><br><span class="line">-rw-r--r-- 1 mysql mysql 1838  7월 16 15:48 server-cert.pem</span><br><span class="line">-rw------- 1 mysql mysql 3243  7월 16 15:48 server-key.pem</span><br><span class="line">-rw-r--r-- 1 mysql mysql 1671  7월 16 15:47 server-req.pem</span><br></pre></td></tr></table></figure>


<h2 id="인증서의-내용-확인방법"><a href="#인증서의-내용-확인방법" class="headerlink" title="인증서의 내용 확인방법"></a>인증서의 내용 확인방법</h2><p>shell &gt; openssl x509 -text -in ca.pem<br>shell &gt; openssl x509 -text -in server-cert.pem<br>shell &gt; openssl x509 -text -in client-cert.pem</p>
<br>

<h1 id="3-사설-CA-인증서-설정"><a href="#3-사설-CA-인증서-설정" class="headerlink" title="3. 사설 CA  인증서 설정"></a>3. 사설 CA  인증서 설정</h1><p>my.cnf 에 TLS 를 위한 구성을 해야 한다. 주로 ssl_cert, ssl_key, ssl_ca 에 대한 인증서 파일을 지정해 준다.</p>
<ul>
<li>ssl_cert 시스템 변수: X509 인증서 경로 지정</li>
<li>ssl_key 시스템 변수: 서버 개인키 경로 지정</li>
<li>ssl_ca 혹은 ssl_capath 시스템 변수: Certificate Authority (CA) 경로</li>
</ul>
<h2 id="TLS-활성화"><a href="#TLS-활성화" class="headerlink" title="TLS 활성화"></a>TLS 활성화</h2><p>참고3 의 mysql 설정파일 my.cnf 에 따르면 아래 변수가 설정되야 한다.</p>
<figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="attribute">mariadb</span>]</span><br><span class="line">...</span><br><span class="line"><span class="attribute">ssl_cert</span> = /etc/ssl/mysql/server-cert.pem</span><br><span class="line"><span class="attribute">ssl_key</span> = /etc/ssl/mysql/server-key.pem</span><br><span class="line"><span class="attribute">ssl_ca</span> = /etc/ssl/mysql/ca.pem</span><br></pre></td></tr></table></figure>

<p>서버를 재시작한다.</p>
<p>TLS 가 활성화 되었는지 환경변수로 확인할 수 있다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%ssl%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name       <span class="operator">|</span> <span class="keyword">Value</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+--------------------------------+</span></span><br><span class="line"><span class="operator">|</span> have_openssl        <span class="operator">|</span> YES                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> have_ssl            <span class="operator">|</span> YES                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ssl_ca              <span class="operator">|</span> <span class="operator">/</span>etc<span class="operator">/</span>ssl<span class="operator">/</span>mysql<span class="operator">/</span>ca.pem          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ssl_capath          <span class="operator">|</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ssl_cert            <span class="operator">|</span> <span class="operator">/</span>etc<span class="operator">/</span>ssl<span class="operator">/</span>mysql<span class="operator">/</span>server<span class="operator">-</span>cert.pem <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ssl_cipher          <span class="operator">|</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ssl_crl             <span class="operator">|</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ssl_crlpath         <span class="operator">|</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ssl_key             <span class="operator">|</span> <span class="operator">/</span>etc<span class="operator">/</span>ssl<span class="operator">/</span>mysql<span class="operator">/</span>server<span class="operator">-</span>key.pem  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> version_ssl_library <span class="operator">|</span> OpenSSL <span class="number">1.1</span><span class="number">.1</span>n  <span class="number">15</span> Mar <span class="number">2022</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+--------------------------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.003</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>이렇게 구성한 TLS 인증서는 만료기간이 있다. 아래 같이 만료  기간을 확인 할 수 있다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span>  <span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Ssl_server_not%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name         <span class="operator">|</span> <span class="keyword">Value</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+--------------------------+</span></span><br><span class="line"><span class="operator">|</span> Ssl_server_not_after  <span class="operator">|</span> Nov <span class="number">16</span> <span class="number">06</span>:<span class="number">48</span>:<span class="number">41</span> <span class="number">3022</span> GMT <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Ssl_server_not_before <span class="operator">|</span> Jul <span class="number">16</span> <span class="number">06</span>:<span class="number">48</span>:<span class="number">41</span> <span class="number">2023</span> GMT <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+--------------------------+</span></span><br></pre></td></tr></table></figure>



<h2 id="mysql-client-TLS-사용-접속"><a href="#mysql-client-TLS-사용-접속" class="headerlink" title="mysql client TLS 사용 접속"></a>mysql client TLS 사용 접속</h2><p>mysql 클라이언트로 TLS 인증서를 사용해서 접속해 보자.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(SERVER) $ mysql -u root -p -h localhost --ssl=TRUE --ssl-ca=/etc/ssl/mysql/ca.pem --ssl-cert=/etc/ssl/mysql/client-cert.pem --ssl-key=/etc/ssl/mysql/client-key.pem</span><br></pre></td></tr></table></figure>

<p>접속한 클라인트에서 status 를 살펴보면 TLS 로 접속한 내역을 <code>SSL: Cipher in use is TLS_AES_256_GCM_SHA384</code> 항목으로 확인할 수 있다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; status</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 15.1 Distrib 10.11.2-MariaDB, for debian-linux-gnu (aarch64) using  EditLine wrapper</span><br><span class="line"></span><br><span class="line">Connection id:          315</span><br><span class="line">Current database:</span><br><span class="line">Current user:           root@localhost</span><br><span class="line">SSL:                    Cipher in use is TLS_AES_256_GCM_SHA384</span><br><span class="line">Current pager:          stdout</span><br><span class="line">Using outfile:          &#x27;&#x27;</span><br><span class="line">Using delimiter:        ;</span><br><span class="line">Server:                 MariaDB</span><br><span class="line">Server version:         10.11.2-MariaDB-1:10.11.2+maria~deb11 mariadb.org binary distribution</span><br><span class="line">Protocol version:       10</span><br><span class="line">Connection:             Localhost via UNIX socket</span><br><span class="line">Server characterset:    utf8mb4</span><br><span class="line">Db     characterset:    utf8mb4</span><br><span class="line">Client characterset:    utf8mb3</span><br><span class="line">Conn.  characterset:    utf8mb3</span><br><span class="line">UNIX socket:            /run/mysqld/mysqld.sock</span><br><span class="line">Uptime:                 6 min 54 sec</span><br><span class="line"></span><br><span class="line">Threads: 69  Questions: 2386  Slow queries: 0  Opens: 37  Open tables: 30  Queries per second avg: 5.763</span><br><span class="line">--------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<br>

<hr>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ol>
<li><a target="_blank" rel="noopener" href="https://susoterran.github.io/mysql/mysql_privatecertificate/">OpenSSL을 이용한 사설 인증서 생성</a></li>
<li><a target="_blank" rel="noopener" href="https://ddart.net/xe/board/12867">MariaDB 외부접속시 ssl 사용법, 그리고 ssl 로 replication(동기화) 하기</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/mysql-security-excerpt/8.0/en/using-encrypted-connections.html">Configuring MySQL to Use Encrypted Connections</a></li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-14T07:00:00.000Z" title="7/14/2023, 4:00:00 PM">2023-07-14</time>&nbsp;게시 됨</span><span class="level-item"><time dateTime="2023-07-15T08:17:32.478Z" title="7/15/2023, 5:17:32 PM">2023-07-15</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Python/">Python</a></span><span class="level-item">7분안에 읽기 (약 1001 단어)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/jupyterlab-multiprocess_print-483b37e7a2c3/">Jupyter 기반 환경에서 Multiprocess 실행시 print 출력 차이.</a></p><div class="content"><p>jupyter notebook에서 실행하면 차일드 프로세스로 실행한 print() 로 출력하는 결과를 확인할 수 업다. print 는 std out 에 출력하도록 되어 있다. 자식 프로세스에서 print 를 호출하면 <code>spawn</code> 을 사용해서 호출되어서 출력되지 않는다.  </p>
<h1 id="차일드-프로세스-print-문제"><a href="#차일드-프로세스-print-문제" class="headerlink" title="차일드 프로세스 print 문제"></a>차일드 프로세스 print 문제</h1><p>아래 코드는 아주 간단하게 메인 프로세스에서 새 프로세스를 생성하고 실행한다. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">msg</span>):</span><br><span class="line">    <span class="built_in">print</span>(msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    proc = Process(target=func, args=(<span class="string">&#x27;Hello multiproess&#x27;</span>,))</span><br><span class="line">    proc.start()</span><br><span class="line">    proc.join()</span><br></pre></td></tr></table></figure>

<p>이 코드는 소스로 쉘에서 실행하거나 Web 기반의 jupyterlab 에서 실행하면 아무 문제이 print 문이 잘 작동하고 출력 결과가 나온다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>! python mutiprocess1.py</span><br><span class="line">Hello multiproess</span><br></pre></td></tr></table></figure>

<blockquote>
<p>print 의 Multiprocessing 에서 문제는 링크 <a href="#footnote1">참고1</a> 을 읽어보기를 권한다. 이 글에서는 테스트한 내용을 정리만 했다.</p>
</blockquote>
<h1 id="원인"><a href="#원인" class="headerlink" title="원인"></a>원인</h1><p>아래 링크 <a href="#footnote1">참고1</a> 기사에서 설명을 자세히 하고 있다. 보통 파이썬에서 차일드 프로세스를 시작할 때는 <code>&#39;fork&#39;, &#39;spawn&#39;, &#39;forkserver&#39;</code> 방법이 있다고 한다. 그런데 spawn 으로 차일드 프로세스를 실행하면 std io 출력 버퍼가 자동으로 비워지지 않는다(print는 기본으로 flush가 되지 않는다). 그러다 보니 차일드 프로세스가 종료 하면서 자동으로 gabage collection에 의해  버퍼에 남아 있는 메시지가 사라지는 것이다.</p>
<h1 id="해결-방법"><a href="#해결-방법" class="headerlink" title="해결 방법"></a>해결 방법</h1><ol>
<li>메시지 버퍼가 사라지기 전에 flush 를 한다.</li>
<li>fork 기반의 프로세스를 생성한다.</li>
</ol>
<h2 id="1-flush-사용"><a href="#1-flush-사용" class="headerlink" title="1. flush 사용"></a>1. flush 사용</h2><ol>
<li>메시지 버퍼가 사라지기 전에 flush 를 한다.</li>
</ol>
<p>이를 해결하기 위해 모든 print 의 출력은 즉시 flush 되도록 flush&#x3D;True 옵션을 사용할 수 있다고 한다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">msg</span>):</span><br><span class="line">    <span class="built_in">print</span>(msg, flush=Yes)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>이 방법은 VS code 현재 jupyter 확장에서는 효과가 없다.</p>
</blockquote>
<h3 id="flush-란"><a href="#flush-란" class="headerlink" title="flush 란?"></a>flush 란?</h3><p>std io 의 버퍼 처리 흐름은 글 <a target="_blank" rel="noopener" href="https://velog.io/@jinh2352/%ED%8C%8C%EC%9D%BC-IO-%EB%B2%84%ED%8D%BC%EB%A7%81">파일 I&#x2F;O 버퍼링</a> 을 살펴보고,</p>
<img src='https://images.velog.io/images/jinh2352/post/f7beb0b1-fb84-4f74-adcf-5956f80833ab/image.png' width=550>


<p>python에서 print 같은 표준 출력의 flush에 대해서 이글 <a target="_blank" rel="noopener" href="https://www.msdotnet.co.in/2020/04/print-function-in-python-language-with.html"></a> 의 그림을 참고한다.</p>
<img src='https://1.bp.blogspot.com/-UrjeTkA4kVA/XpcsMVPBIHI/AAAAAAAAHRg/EDERNZm9L4MIEWEtyIiJ42par-sIChx3wCLcBGAsYHQ/s640/FLUSH%2BIN%2BPYTHON.JPG' width=550>


<h2 id="2-fork-기반의-프로세스를-생성한다"><a href="#2-fork-기반의-프로세스를-생성한다" class="headerlink" title="2. fork 기반의 프로세스를 생성한다."></a>2. fork 기반의 프로세스를 생성한다.</h2><p>지원되는 프로세스 시작 방법은 아래 같이 확인이 가능하다. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing <span class="keyword">as</span> mp</span><br><span class="line"></span><br><span class="line">mp.get_start_method()       <span class="comment"># 현재 start 메서드</span></span><br><span class="line">mp.get_all_start_methods()  <span class="comment"># 모든 start 메서드</span></span><br></pre></td></tr></table></figure>

<p>아래 같이 start method 를 <code>fork</code> 로 강제 사용할 수 있다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing <span class="keyword">as</span> mp</span><br><span class="line"></span><br><span class="line">mp.set_start_method(<span class="string">&#x27;fork&#x27;</span>)       <span class="comment"># 현재 start 메서드</span></span><br></pre></td></tr></table></figure>

<p>브라우저 기반의 jupyter 실행환경은  <code>&#39;fork&#39;, &#39;spawn&#39;, &#39;forkserver&#39;</code> 를 모두 가능하다. 하지만 현재 VS code 의 jupyter 확장은 에서는 <code>spawn</code> 만 지원하고 있다.</p>
<h2 id="fork-spawn"><a href="#fork-spawn" class="headerlink" title="fork, spawn"></a>fork, spawn</h2><p>링크 <a href="#footnote2">침고2</a> 에 있는 글에서 Fork, Spawn 에 대한 설명을 읽어보자.</p>
<p>Forking</p>
<ul>
<li>포크한 부모 프로세스의 이미지를 그래도 사용한다.</li>
</ul>
<img src='https://d33wubrfki0l68.cloudfront.net/8c3a4605e6d501f6a448faafd71cd2047d9d2e07/b9b18/blog/assets/2019-11-13-python-forkserver-preload/python-forkserver-0.png' width=550>


<p>Spwaning</p>
<ul>
<li>포크한 부모 프로세스와 다르게 새 이미지로 갱신한다.</li>
</ul>
<img src='https://d33wubrfki0l68.cloudfront.net/8d5e9dd98d91090aeecb72cf9e956b3afe679fd6/3b168/blog/assets/2019-11-13-python-forkserver-preload/python-forkserver-1.png' width=500>


<h1 id="sleep-으로-지연하면"><a href="#sleep-으로-지연하면" class="headerlink" title="sleep 으로 지연하면?"></a>sleep 으로 지연하면?</h1><p>VS code 환경에서 아래 같이 sleep 으로 지연을 주어 봤지만 해결이 안된다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">msg</span>):</span><br><span class="line">    <span class="built_in">print</span>(msg, flush=<span class="literal">True</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    proc = mp.Process(target=func, args=(<span class="string">&#x27;Hello multiproess&#x27;</span>,))</span><br><span class="line">    proc.start()</span><br><span class="line">    proc.join()</span><br></pre></td></tr></table></figure>

<p>아래 같이 join 전에 sleep 으로 지연</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">msg</span>):</span><br><span class="line">    <span class="built_in">print</span>(msg, flush=<span class="literal">True</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    proc = mp.Process(target=func, args=(<span class="string">&#x27;Hello multiproess&#x27;</span>,))</span><br><span class="line">    proc.start()</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    proc.join()</span><br></pre></td></tr></table></figure>


<h1 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h1><p>현재 테스트한 VS Code 의 jupyter 확장 버전은 아래 같다.</p>
<ul>
<li>Windows VS code, Jupyter Extension<ul>
<li>v2023.6.1101941928</li>
<li>v2023.7.1001901100</li>
</ul>
</li>
</ul>
<p>만약 VS code 에서 Multiprocess 디버깅시 다른 logger 라이브러리 등을 이용해야 할 것 같다.</p>
<hr>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><p><a name='footnote1'>참고1</a> :  <a target="_blank" rel="noopener" href="https://superfastpython.com/multiprocessing-print/">How to print() from a Child Process in Python</a></p>
<p><a name='footnote2'>참고2</a> : <a target="_blank" rel="noopener" href="https://sunyzero.tistory.com/191">fork, vfork 그리고 posix_spawn 이야기</a></p>
<p><a name='footnote2'>참고3</a> : <a target="_blank" rel="noopener" href="https://bnikolic.co.uk/blog/python/parallelism/2019/11/13/python-forkserver-preload.html">foring, spawning 이미지</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-13T13:00:00.000Z" title="7/13/2023, 10:00:00 PM">2023-07-13</time>&nbsp;게시 됨</span><span class="level-item"><time dateTime="2023-07-13T15:10:03.857Z" title="7/14/2023, 12:10:03 AM">2023-07-14</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Python/">Python</a></span><span class="level-item">4분안에 읽기 (약 646 단어)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/windows-conda-shell-cbeeac74bbce/">Windows Terminal에서 miniconda/ananconda Profile 사용</a></p><div class="content"><p>Anaconda &#x2F; Miniconda 를 설치하고 윈도우즈에서 실행시 바로가기로 사용하는 방법을 정리했다. 모든 Commandline, Powershell 에서 conda 명령을 사용하려면 환경변수 <code>PATH</code> 에 지정을 해야 한다. 이 글에서는 바로가기를 사용하면 <code>PATH</code> 환경변수를 활용하지 않고도 쉽게 사용할 수 있다.</p>
<blockquote>
<p>Anaconda&#x2F;Miniconda 설치 프로그램으로 설치를 하면 바로가기를 만들어 준다. 여기서 힌트를 얻으면 된다.</p>
</blockquote>
<img src='/images/python/conda-powershell02.png'>


<p>바로가기 속성을 사용해 파워쉘로 conda 환경을 초기화 하기 위해서는 conda-hook.ps1 실행이 필요하다. 설치한 Anaconda 시작프로그램의 속성을 통해 알 수 있다. 보통 설치된 아래 위치에 있다.</p>
<ul>
<li><code>C:\Users\USERID\miniconda3\shell\condabin\conda-hook.ps1</code></li>
</ul>
<img src='/images/python/conda-powershell01.png'>


<h1 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h1><p>윈도우 기본 파워쉘과 Powershell 7 으로 바로가기 설정을 보면, conda-hook.ps1 을 포함해 바로가기 아이콘 속성에 파워쉘을 통해 실행하도록 설정하면 된다.</p>
<h2 id="PowerShell-7"><a href="#PowerShell-7" class="headerlink" title="PowerShell 7"></a>PowerShell 7</h2><p>powershell 7 으로 Miniconda3 의 base 가상환경 기반 쉘을 실행한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;C:\Program Files\PowerShell\7\pwsh.exe&quot; -ExecutionPolicy ByPass -NoExit -Command &quot;&amp; &#x27;C:\Users\USERID\miniconda3\shell\condabin\conda-hook.ps1&#x27; ; conda activate &#x27;C:\Users\USERID\miniconda3&#x27; &quot;</span><br></pre></td></tr></table></figure>


<h2 id="기본-PowerShell-버전"><a href="#기본-PowerShell-버전" class="headerlink" title="기본 PowerShell 버전"></a>기본 PowerShell 버전</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">%</span><span class="language-bash">windir%\System32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy ByPass -NoExit -Command <span class="string">&quot;&amp; &#x27;C:\Users\USERID\miniconda3\shell\condabin\conda-hook.ps1&#x27; ; conda activate &#x27;C:\Users\USERID\miniconda3&#x27; &quot;</span></span></span><br></pre></td></tr></table></figure>


<h1 id="Command-Line"><a href="#Command-Line" class="headerlink" title="Command Line"></a>Command Line</h1><p>윈도우 Command 로 anaconda &#x2F; miniconda 를 실행하려면 아래 같이 activate.bat 배치를 실행하면 된다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">%</span><span class="language-bash">windir%\System32\cmd.exe <span class="string">&quot;/K&quot;</span> C:\Users\daddy\miniconda3\Scripts\activate.bat C:\Users\daddy\miniconda3</span></span><br></pre></td></tr></table></figure>

<br>

<h1 id="Windows-Terminal-프로파일-설정"><a href="#Windows-Terminal-프로파일-설정" class="headerlink" title="Windows Terminal 프로파일 설정"></a>Windows Terminal 프로파일 설정</h1><p>윈도우 터미널에 새 프로파일 추가시 랜덤한 GUID 값이 필요하다. 터미널에서 New-Guid 명령으로 발행해 사용한다.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span>&gt; <span class="built_in">New-Guid</span></span><br><span class="line"></span><br><span class="line">Guid</span><br><span class="line"><span class="literal">----</span></span><br><span class="line"><span class="number">9</span>f2a1a27<span class="literal">-fe9b-4421-ba19-6cea57188b17</span></span><br></pre></td></tr></table></figure>

<h2 id="PowerShell-7-버전"><a href="#PowerShell-7-버전" class="headerlink" title="PowerShell 7 버전"></a>PowerShell 7 버전</h2><p>guid 는 New-Guid 로 발행해서 등록하면 된다.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;commandline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C:\\Program Files\\PowerShell\\7\\pwsh.exe -ExecutionPolicy ByPass -NoExit -Command \&quot;&amp; &#x27;C:\\Users\\USERID\\miniconda3\\shell\\condabin\\conda-hook.ps1&#x27; ; conda activate &#x27;C:\\Users\\daddy\\miniconda3&#x27; \&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;guid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;fe2a1a27-9efb-4421-ba19-6cea57188b17&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Miniconda3 64bit(ps7)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;startingDirectory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%USERPROFILE%&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;commandline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C:\\Program Files\\PowerShell\\7\\pwsh.exe -ExecutionPolicy ByPass -NoExit -Command \&quot;&amp; &#x27;C:\\Users\\USERID\\anaconda3\\shell\\condabin\\conda-hook.ps1&#x27; ; conda activate &#x27;C:\\Users\\daddy\\anaconda3&#x27; \&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;guid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;3f2k7199-d35c-44e5-b82d-7cd5442175fc&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Anaconda 64bit(ps7)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;startingDirectory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%USERPROFILE%&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>


<h2 id="윈도우-기본-PowerShell-버전"><a href="#윈도우-기본-PowerShell-버전" class="headerlink" title="윈도우 기본 PowerShell 버전"></a>윈도우 기본 PowerShell 버전</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;commandline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%windir%\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -ExecutionPolicy ByPass -NoExit -Command \&quot;&amp; &#x27;C:\\Users\\USERID\\miniconda3\\shell\\condabin\\conda-hook.ps1&#x27; ; conda activate &#x27;C:\\Users\\daddy\\miniconda3&#x27; \&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;guid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;573e44d9-1ff5-4f3f-b083-1b2fd9a6a575&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Miniconda3 64bit&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;startingDirectory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%USERPROFILE%&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;commandline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%windir%\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -ExecutionPolicy ByPass -NoExit -Command \&quot;&amp; &#x27;C:\\Users\\USERID\\anaconda3\\shell\\condabin\\conda-hook.ps1&#x27; ; conda activate &#x27;C:\\Users\\daddy\\anaconda3&#x27; \&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;guid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;f441f482-8cf6-47ed-9a9c-fc40df46c9ac&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Anaconda 64bit&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;startingDirectory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%USERPROFILE%&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-12T17:00:00.000Z" title="7/13/2023, 2:00:00 AM">2023-07-13</time>&nbsp;게시 됨</span><span class="level-item"><time dateTime="2023-07-12T17:57:34.916Z" title="7/13/2023, 2:57:34 AM">2023-07-13</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Python/">Python</a></span><span class="level-item">10분안에 읽기 (약 1462 단어)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/pd-Stack_Unstack_Melt-9d0bcd365efe/">Pandas - Pivot, Stack, Unstack, Melt</a></p><div class="content"><p>Pandas 에서 2차원 data를 Stack, unstack, melt 를 이용해 복합 인덱스를 사용할 수 있고 Pivot 을 이용해 특정 데이터 중심의 2차원 데이터로 생성할 수 있다.</p>
<ol>
<li>Pivot</li>
<li>Stack &amp; Unstack</li>
<li>Melt</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br></pre></td></tr></table></figure>

<h1 id="2차원-테이블"><a href="#2차원-테이블" class="headerlink" title="2차원 테이블"></a>2차원 테이블</h1><p>행과 열로 구성된 데이터 집합</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">df = pd.DataFrame(</span><br><span class="line">    &#123;<span class="string">&#x27;foo&#x27;</span> : [<span class="string">&#x27;One&#x27;</span>,<span class="string">&#x27;One&#x27;</span>,<span class="string">&#x27;One&#x27;</span>,<span class="string">&#x27;Two&#x27;</span>,<span class="string">&#x27;Two&#x27;</span>,<span class="string">&#x27;Two&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;bar&#x27;</span>: [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;baz&#x27;</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>] ,</span><br><span class="line">        <span class="string">&#x27;zoo&#x27;</span>: [<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;z&#x27;</span>,<span class="string">&#x27;q&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;t&#x27;</span>]&#125;</span><br><span class="line">)</span><br><span class="line">df</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>foo</th>
      <th>bar</th>
      <th>baz</th>
      <th>zoo</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>One</td>
      <td>A</td>
      <td>1</td>
      <td>x</td>
    </tr>
    <tr>
      <th>1</th>
      <td>One</td>
      <td>B</td>
      <td>2</td>
      <td>y</td>
    </tr>
    <tr>
      <th>2</th>
      <td>One</td>
      <td>C</td>
      <td>3</td>
      <td>z</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Two</td>
      <td>A</td>
      <td>4</td>
      <td>q</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Two</td>
      <td>B</td>
      <td>5</td>
      <td>w</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Two</td>
      <td>C</td>
      <td>6</td>
      <td>t</td>
    </tr>
  </tbody>
</table>
</div>



<h1 id="Pivot"><a href="#Pivot" class="headerlink" title="Pivot"></a>Pivot</h1><p>피봇&#x2F;피봇 테이블은 2차원 데이터 열에서 공통된 부분을 중심으로 새 테이블 집합을 형성하게 해준다.  피봇은 index, columns, values 라는 이름을 가진 세 가지 parameter를 취한다. 이러한 각 파라미터의 값으로 원래 표에 열 이름을 지정해야 한다.</p>
<img src='https://pandas.pydata.org/docs/_images/reshaping_pivot.png'>

<p>foo, bar, baz, zoo 컬럼 중에서 foo 에 대해서 정리를 하고 bar 를 컬럼으로 지정하면 아래와 같다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df_pivot = df.pivot_table(index=<span class="string">&#x27;foo&#x27;</span>, columns=<span class="string">&#x27;bar&#x27;</span>, values=<span class="string">&#x27;baz&#x27;</span>)</span><br><span class="line">df_pivot</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>bar</th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
    <tr>
      <th>foo</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>One</th>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>Two</th>
      <td>4</td>
      <td>5</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div>



<h3 id="ex-nba-데이터를-포지션의-연령별-연봉-테이블로-전환"><a href="#ex-nba-데이터를-포지션의-연령별-연봉-테이블로-전환" class="headerlink" title="ex) nba 데이터를 포지션의 연령별 연봉 테이블로 전환"></a>ex) nba 데이터를 포지션의 연령별 연봉 테이블로 전환</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dfnba = pd.read_csv(<span class="string">&#x27;../data/nba.csv&#x27;</span>)</span><br><span class="line">dfnba</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Name</th>
      <th>Team</th>
      <th>Number</th>
      <th>Position</th>
      <th>Age</th>
      <th>Height</th>
      <th>Weight</th>
      <th>College</th>
      <th>Salary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Avery Bradley</td>
      <td>Boston Celtics</td>
      <td>0.0</td>
      <td>PG</td>
      <td>25.0</td>
      <td>6-2</td>
      <td>180.0</td>
      <td>Texas</td>
      <td>7730337.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Jae Crowder</td>
      <td>Boston Celtics</td>
      <td>99.0</td>
      <td>SF</td>
      <td>25.0</td>
      <td>6-6</td>
      <td>235.0</td>
      <td>Marquette</td>
      <td>6796117.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>John Holland</td>
      <td>Boston Celtics</td>
      <td>30.0</td>
      <td>SG</td>
      <td>27.0</td>
      <td>6-5</td>
      <td>205.0</td>
      <td>Boston University</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>R.J. Hunter</td>
      <td>Boston Celtics</td>
      <td>28.0</td>
      <td>SG</td>
      <td>22.0</td>
      <td>6-5</td>
      <td>185.0</td>
      <td>Georgia State</td>
      <td>1148640.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Jonas Jerebko</td>
      <td>Boston Celtics</td>
      <td>8.0</td>
      <td>PF</td>
      <td>29.0</td>
      <td>6-10</td>
      <td>231.0</td>
      <td>NaN</td>
      <td>5000000.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>453</th>
      <td>Shelvin Mack</td>
      <td>Utah Jazz</td>
      <td>8.0</td>
      <td>PG</td>
      <td>26.0</td>
      <td>6-3</td>
      <td>203.0</td>
      <td>Butler</td>
      <td>2433333.0</td>
    </tr>
    <tr>
      <th>454</th>
      <td>Raul Neto</td>
      <td>Utah Jazz</td>
      <td>25.0</td>
      <td>PG</td>
      <td>24.0</td>
      <td>6-1</td>
      <td>179.0</td>
      <td>NaN</td>
      <td>900000.0</td>
    </tr>
    <tr>
      <th>455</th>
      <td>Tibor Pleiss</td>
      <td>Utah Jazz</td>
      <td>21.0</td>
      <td>C</td>
      <td>26.0</td>
      <td>7-3</td>
      <td>256.0</td>
      <td>NaN</td>
      <td>2900000.0</td>
    </tr>
    <tr>
      <th>456</th>
      <td>Jeff Withey</td>
      <td>Utah Jazz</td>
      <td>24.0</td>
      <td>C</td>
      <td>26.0</td>
      <td>7-0</td>
      <td>231.0</td>
      <td>Kansas</td>
      <td>947276.0</td>
    </tr>
    <tr>
      <th>457</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>458 rows × 9 columns</p>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pd.options.display.float_format = <span class="string">&quot;&#123;:,.2f&#125;&quot;</span>.<span class="built_in">format</span></span><br></pre></td></tr></table></figure>

<p>컬럼의 데이터에 공통된 모습이 많이 보인다. 이 중에서 포지션을 기준으로 나이에 따른 연봉을 본다고 가정하면 포지션을 인덱스로하고 나이를 컬럼으로 지정하면 아래와 같다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 포지션의 연령별 연봉 테이블</span></span><br><span class="line">dfnba.pivot_table(index=<span class="string">&#x27;Position&#x27;</span>, columns=<span class="string">&#x27;Age&#x27;</span>, values=<span class="string">&#x27;Salary&#x27;</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Age</th>
      <th>19.00</th>
      <th>20.00</th>
      <th>21.00</th>
      <th>22.00</th>
      <th>23.00</th>
      <th>24.00</th>
      <th>25.00</th>
      <th>26.00</th>
      <th>27.00</th>
      <th>28.00</th>
      <th>...</th>
      <th>31.00</th>
      <th>32.00</th>
      <th>33.00</th>
      <th>34.00</th>
      <th>35.00</th>
      <th>36.00</th>
      <th>37.00</th>
      <th>38.00</th>
      <th>39.00</th>
      <th>40.00</th>
    </tr>
    <tr>
      <th>Position</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>C</th>
      <td>NaN</td>
      <td>5,143,140.00</td>
      <td>1,571,000.00</td>
      <td>3,476,698.20</td>
      <td>2,121,999.50</td>
      <td>4,532,003.33</td>
      <td>10,881,995.00</td>
      <td>3,041,850.82</td>
      <td>5,004,260.50</td>
      <td>7,635,761.83</td>
      <td>...</td>
      <td>10,338,218.00</td>
      <td>8,208,695.50</td>
      <td>9,500,000.00</td>
      <td>6,258,000.00</td>
      <td>7,448,760.00</td>
      <td>947,276.00</td>
      <td>NaN</td>
      <td>222,888.00</td>
      <td>NaN</td>
      <td>5,250,000.00</td>
    </tr>
    <tr>
      <th>PF</th>
      <td>NaN</td>
      <td>2,369,838.00</td>
      <td>2,397,408.00</td>
      <td>1,601,105.80</td>
      <td>2,399,120.50</td>
      <td>2,577,551.44</td>
      <td>2,195,476.60</td>
      <td>7,228,086.75</td>
      <td>9,217,098.43</td>
      <td>5,268,839.17</td>
      <td>...</td>
      <td>5,323,787.00</td>
      <td>14,346,365.00</td>
      <td>2,630,241.40</td>
      <td>6,469,277.50</td>
      <td>2,624,593.50</td>
      <td>2,877,470.00</td>
      <td>6,666,667.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8,500,000.00</td>
    </tr>
    <tr>
      <th>PG</th>
      <td>NaN</td>
      <td>3,316,290.00</td>
      <td>1,944,080.00</td>
      <td>2,381,130.00</td>
      <td>1,627,769.00</td>
      <td>4,652,526.50</td>
      <td>5,422,085.80</td>
      <td>10,038,174.80</td>
      <td>5,944,070.17</td>
      <td>5,021,965.17</td>
      <td>...</td>
      <td>7,467,596.40</td>
      <td>4,082,425.33</td>
      <td>2,226,179.67</td>
      <td>8,395,104.00</td>
      <td>NaN</td>
      <td>2,170,465.00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>947,726.00</td>
      <td>250,750.00</td>
    </tr>
    <tr>
      <th>SF</th>
      <td>NaN</td>
      <td>1,979,976.00</td>
      <td>1,404,480.00</td>
      <td>2,401,364.60</td>
      <td>2,760,134.36</td>
      <td>5,067,491.60</td>
      <td>3,382,640.73</td>
      <td>7,322,325.20</td>
      <td>10,532,567.00</td>
      <td>1,996,608.71</td>
      <td>...</td>
      <td>10,960,320.25</td>
      <td>9,720,195.75</td>
      <td>NaN</td>
      <td>261,894.00</td>
      <td>947,276.00</td>
      <td>1,721,559.75</td>
      <td>25,000,000.00</td>
      <td>3,376,000.00</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>SG</th>
      <td>1,930,440.00</td>
      <td>1,749,840.00</td>
      <td>2,215,710.43</td>
      <td>2,055,241.00</td>
      <td>1,388,251.18</td>
      <td>3,205,720.53</td>
      <td>1,782,834.89</td>
      <td>9,872,690.29</td>
      <td>4,815,524.62</td>
      <td>6,354,000.00</td>
      <td>...</td>
      <td>7,085,000.00</td>
      <td>2,041,138.00</td>
      <td>2,233,533.33</td>
      <td>12,579,269.50</td>
      <td>3,512,173.75</td>
      <td>3,311,138.00</td>
      <td>NaN</td>
      <td>1,880,638.00</td>
      <td>4,088,019.00</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 22 columns</p>
</div>



<h1 id="Stack-amp-Unstack"><a href="#Stack-amp-Unstack" class="headerlink" title="Stack &amp; Unstack"></a>Stack &amp; Unstack</h1><p>2차원 테이블은 행 과 열이 순차적 값으로 교차하게 되어 있다. 스택은 컬럼의 값을 아래-위로 배치를 시킨다고 상상이 된다. 그래서 스택과 언스택은 이렇게 생각된다.</p>
<ul>
<li>stack : 2차원 컬럼의 내용을 수직방향으로 쌓는 구조, 즉 새로운 인덱스가 더해진다.</li>
<li>unstack : 인덱스 구성요소를 한 단계 컬럼으로 만들며 수평방향으로 쌓게 한다.</li>
</ul>
<p>stack</p>
<p><img src='https://pandas.pydata.org/docs/_images/reshaping_stack.png'> <a target="_blank" rel="noopener" href="https://pandas.pydata.org/docs/user_guide/reshaping.html">pandas reshaping</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">df_single_level = pd.DataFrame(</span><br><span class="line">    [[<span class="string">&#x27;Mostly cloudy&#x27;</span>, <span class="number">10</span>], [<span class="string">&#x27;Sunny&#x27;</span>, <span class="number">12</span>]],</span><br><span class="line">    index=[<span class="string">&#x27;London&#x27;</span>, <span class="string">&#x27;Oxford&#x27;</span>],</span><br><span class="line">    columns=[<span class="string">&#x27;Weather&#x27;</span>, <span class="string">&#x27;Wind&#x27;</span>]</span><br><span class="line">)</span><br><span class="line">df_single_level</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Weather</th>
      <th>Wind</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>London</th>
      <td>Mostly cloudy</td>
      <td>10</td>
    </tr>
    <tr>
      <th>Oxford</th>
      <td>Sunny</td>
      <td>12</td>
    </tr>
  </tbody>
</table>
</div>



<p>index와 weather, wind 라는 컬럼을 stack을 호출하면 weather-wind 관련 인덱스를 생성하고 데이터를 나열한다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df_single_level.stack()</span><br></pre></td></tr></table></figure>




<pre><code>London  Weather    Mostly cloudy
        Wind                  10
Oxford  Weather            Sunny
        Wind                  12
dtype: object
</code></pre>
<p>다른 데이터를 살펴보자.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MultiIndex</span></span><br><span class="line">tuples = <span class="built_in">list</span>(</span><br><span class="line">    <span class="built_in">zip</span>(</span><br><span class="line">        *[</span><br><span class="line">            [<span class="string">&quot;bar&quot;</span>, <span class="string">&quot;bar&quot;</span>, <span class="string">&quot;baz&quot;</span>, <span class="string">&quot;baz&quot;</span>, <span class="string">&quot;foo&quot;</span>, <span class="string">&quot;foo&quot;</span>, <span class="string">&quot;qux&quot;</span>, <span class="string">&quot;qux&quot;</span>],</span><br><span class="line">            [<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>],</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line">index = pd.MultiIndex.from_tuples(tuples, names=[<span class="string">&quot;first&quot;</span>, <span class="string">&quot;second&quot;</span>])</span><br><span class="line">df = pd.DataFrame(np.random.randn(<span class="number">8</span>, <span class="number">2</span>), index=index, columns=[<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>])</span><br><span class="line">df</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A</th>
      <th>B</th>
    </tr>
    <tr>
      <th>first</th>
      <th>second</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">bar</th>
      <th>one</th>
      <td>-1.301694</td>
      <td>-0.013259</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.197846</td>
      <td>0.879890</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">baz</th>
      <th>one</th>
      <td>0.718211</td>
      <td>-0.739434</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.140217</td>
      <td>0.071260</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">foo</th>
      <th>one</th>
      <td>-1.142268</td>
      <td>-2.606413</td>
    </tr>
    <tr>
      <th>two</th>
      <td>1.119145</td>
      <td>0.109402</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">qux</th>
      <th>one</th>
      <td>-0.504167</td>
      <td>-1.703280</td>
    </tr>
    <tr>
      <th>two</th>
      <td>1.064976</td>
      <td>1.011060</td>
    </tr>
  </tbody>
</table>
</div>



<p>위 데이터는 stack()을 하면 A, B 컬럼이 MultiIndex 로 추가되며 A, B 컬럼 데이터 포인트가 배치된다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.stack()</span><br></pre></td></tr></table></figure>




<pre><code>first  second   
bar    one     A   -1.301694
               B   -0.013259
       two     A   -0.197846
               B    0.879890
baz    one     A    0.718211
               B   -0.739434
       two     A   -0.140217
               B    0.071260
foo    one     A   -1.142268
               B   -2.606413
       two     A    1.119145
               B    0.109402
qux    one     A   -0.504167
               B   -1.703280
       two     A    1.064976
               B    1.011060
dtype: float64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df2 = df[:<span class="number">4</span>]</span><br><span class="line">df2</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A</th>
      <th>B</th>
    </tr>
    <tr>
      <th>first</th>
      <th>second</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">bar</th>
      <th>one</th>
      <td>-1.301694</td>
      <td>-0.013259</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.197846</td>
      <td>0.879890</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">baz</th>
      <th>one</th>
      <td>0.718211</td>
      <td>-0.739434</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.140217</td>
      <td>0.071260</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stacked = df2.stack()</span><br><span class="line">stacked</span><br></pre></td></tr></table></figure>




<pre><code>first  second   
bar    one     A   -1.301694
               B   -0.013259
       two     A   -0.197846
               B    0.879890
baz    one     A    0.718211
               B   -0.739434
       two     A   -0.140217
               B    0.071260
dtype: float64
</code></pre>
<p>Unstack</p>
<p><img src='https://pandas.pydata.org/docs/_images/reshaping_unstack.png'> <a target="_blank" rel="noopener" href="https://pandas.pydata.org/docs/user_guide/reshaping.html">pandas reshaping</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stacked</span><br></pre></td></tr></table></figure>




<pre><code>first  second   
bar    one     A   -1.301694
               B   -0.013259
       two     A   -0.197846
               B    0.879890
baz    one     A    0.718211
               B   -0.739434
       two     A   -0.140217
               B    0.071260
dtype: float64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stacked.unstack()</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A</th>
      <th>B</th>
    </tr>
    <tr>
      <th>first</th>
      <th>second</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">bar</th>
      <th>one</th>
      <td>-1.301694</td>
      <td>-0.013259</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.197846</td>
      <td>0.879890</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">baz</th>
      <th>one</th>
      <td>0.718211</td>
      <td>-0.739434</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.140217</td>
      <td>0.071260</td>
    </tr>
  </tbody>
</table>
</div>



<p>레벨을 지정</p>
<img src='https://pandas.pydata.org/docs/_images/reshaping_unstack_1.png'>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stacked.unstack(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>second</th>
      <th>one</th>
      <th>two</th>
    </tr>
    <tr>
      <th>first</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">bar</th>
      <th>A</th>
      <td>-1.301694</td>
      <td>-0.197846</td>
    </tr>
    <tr>
      <th>B</th>
      <td>-0.013259</td>
      <td>0.879890</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">baz</th>
      <th>A</th>
      <td>0.718211</td>
      <td>-0.140217</td>
    </tr>
    <tr>
      <th>B</th>
      <td>-0.739434</td>
      <td>0.071260</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stacked.unstack(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A</th>
      <th>B</th>
    </tr>
    <tr>
      <th>first</th>
      <th>second</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">bar</th>
      <th>one</th>
      <td>-1.301694</td>
      <td>-0.013259</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.197846</td>
      <td>0.879890</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">baz</th>
      <th>one</th>
      <td>0.718211</td>
      <td>-0.739434</td>
    </tr>
    <tr>
      <th>two</th>
      <td>-0.140217</td>
      <td>0.071260</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Melt"><a href="#Melt" class="headerlink" title="Melt"></a>Melt</h1><p>melt() 는 ID 변수를 기준으로 원래 데이터셋에 있던 여러개의 칼럼 이름을 ‘variable’ 칼럼에 위에서 아래로 길게 쌓아놓고, ‘value’ 칼럼에 ID와 variable에 해당하는 값을 넣어주는 식으로 데이터를 재구조화합니다.  </p>
<img src='https://pandas.pydata.org/docs/_images/reshaping_melt.png'>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cheese = pd.DataFrame(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;first&quot;</span>: [<span class="string">&quot;John&quot;</span>, <span class="string">&quot;Mary&quot;</span>],</span><br><span class="line">        <span class="string">&quot;last&quot;</span>: [<span class="string">&quot;Doe&quot;</span>, <span class="string">&quot;Bo&quot;</span>],</span><br><span class="line">        <span class="string">&quot;height&quot;</span>: [<span class="number">5.5</span>, <span class="number">6.0</span>],</span><br><span class="line">        <span class="string">&quot;weight&quot;</span>: [<span class="number">130</span>, <span class="number">150</span>],</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">cheese</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>first</th>
      <th>last</th>
      <th>height</th>
      <th>weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>John</td>
      <td>Doe</td>
      <td>5.50</td>
      <td>130</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Mary</td>
      <td>Bo</td>
      <td>6.00</td>
      <td>150</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># colums중 height, weight 를 row 로 융합</span></span><br><span class="line">cheese.melt(id_vars=[<span class="string">&#x27;first&#x27;</span>,<span class="string">&#x27;last&#x27;</span>]) <span class="comment"># first, last 인덱스로 나머지 컬럼은 value 로 치환</span></span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>first</th>
      <th>last</th>
      <th>variable</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>John</td>
      <td>Doe</td>
      <td>height</td>
      <td>5.50</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Mary</td>
      <td>Bo</td>
      <td>height</td>
      <td>6.00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>John</td>
      <td>Doe</td>
      <td>weight</td>
      <td>130.00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Mary</td>
      <td>Bo</td>
      <td>weight</td>
      <td>150.00</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cheese.melt(id_vars=[<span class="string">&#x27;first&#x27;</span>,<span class="string">&#x27;last&#x27;</span>], value_name=<span class="string">&#x27;quantity&#x27;</span>) </span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th &#123;
    vertical-align: top;
&#125;

.dataframe thead th &#123;
    text-align: right;
&#125;
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>first</th>
      <th>last</th>
      <th>variable</th>
      <th>quantity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>John</td>
      <td>Doe</td>
      <td>height</td>
      <td>5.50</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Mary</td>
      <td>Bo</td>
      <td>height</td>
      <td>6.00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>John</td>
      <td>Doe</td>
      <td>weight</td>
      <td>130.00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Mary</td>
      <td>Bo</td>
      <td>weight</td>
      <td>150.00</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ol>
<li><a target="_blank" rel="noopener" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.stack.html">pandas.DataFrame.stack</a></li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-12T10:00:00.000Z" title="7/12/2023, 7:00:00 PM">2023-07-12</time>&nbsp;게시 됨</span><span class="level-item"><time dateTime="2023-07-12T17:37:18.317Z" title="7/13/2023, 2:37:18 AM">2023-07-13</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Python/">Python</a></span><span class="level-item">2분안에 읽기 (약 354 단어)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/vscode-language-server-24eec7ce2732/">VSCode 에서 languageserver 확인</a></p><div class="content"><p>VS Code에서 Jupyterlab 3.x를 사용하는데 classic jupyter notebook 에서 가능하던 content assistance 기능이 작동을 하지 않았다. </p>
<h1 id="상황"><a href="#상황" class="headerlink" title="상황"></a>상황</h1><p>Jupyterlab, classic jupyter notebook 에서 가능하던 content assistance 기능으로 속성&#x2F;모듈&#x2F;함수&#x2F;도움말 등의 지원이 가능했다.</p>
<ul>
<li>Jupyterlab에서 노트북 셀의 tab &amp; shift tab</li>
</ul>
<img src="/images/python/vs-jupyter-assistance1.png">
그림>


<p>그런데 Visual studio code 에서 <code>.ipynb</code> 노트북 파일을 열어 사용하면 이런 기능이 안되고 있어서 궁금했다.</p>
<p>구글 검색으로 스택오버플로우에 올라온 기사를 보니 <code>settings.json</code> 을 보면 python language server 설정을 해야 한다고 한다. 현재는 Default 상태로 선택되어 있어서 그렇다고 한다. 그래서 Pylance 를 지정했다.</p>
<img src="/images/python/vs-jupyter-assistance2.png">

<p>languageserver 를 지정하고 재시작한 후 살펴보니 잘 된다.</p>
<img src="/images/python/vs-jupyter-assistance3.png">

<h2 id="Language-Server-extension-이란"><a href="#Language-Server-extension-이란" class="headerlink" title="Language Server extension 이란?"></a>Language Server extension 이란?</h2><p><a target="_blank" rel="noopener" href="https://code.visualstudio.com/api/language-extensions/language-server-extension-guide">language-server-extension-guide</a> 에서 설명한 바로는</p>
<blockquote>
<p>여러 프로그래밍 언어에 대해서 강력한 편집 경험을 제공하고자 한다.</p>
</blockquote>
<p>아래 그림에서 languageserver 의 효과를 설명하고 있다. 왼쪽 같이 LSP 가 없으면 각 편집기에서 직접 언어 엔진을 가동해야 한다. 그런데 오른쪽 깥이 LSP를 사용하면 하나의 서버를 통해서 여러 편집기에서 언어의 특성을 활용할 수 있다는 설명 이다.</p>
<img src='https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/lsp-languages-editors.png' backgrounds="#FFFFFF">
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-09T17:00:00.000Z" title="7/10/2023, 2:00:00 AM">2023-07-10</time>&nbsp;게시 됨</span><span class="level-item"><time dateTime="2023-07-13T09:01:32.428Z" title="7/13/2023, 6:01:32 PM">2023-07-13</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Python/">Python</a></span><span class="level-item">9분안에 읽기 (약 1294 단어)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/pandas-numpy-display_format-5e6e2759a37b/">Pandas/Numpy 숫자의 출력 옵션 조정</a></p><div class="content"><p>numpy 와 pandas 에서 수를 출력할 때 형식, 크기 및 범위를 설정할 수 있다. 간단히 보면 아래 테이블 같이 형식을 바꿔준다.</p>
<table>
<thead>
<tr>
<th>column</th>
<th>변환</th>
<th>column</th>
</tr>
</thead>
<tbody><tr>
<td>1e6</td>
<td>precision</td>
<td>1,000,000</td>
</tr>
<tr>
<td>1.1e-6</td>
<td>format</td>
<td>0.1</td>
</tr>
</tbody></table>
<p>아래 요약한 옵션 방법을 사용해서 Numpy 와 Pandas에 있는 숫자를 출력할 때 표현방법, 표기법, 환률, 정밀도 등을 변경해 사용할 수 있다</p>
<h1 id="numpy-출력-형식-변경"><a href="#numpy-출력-형식-변경" class="headerlink" title="numpy 출력 형식 변경"></a>numpy 출력 형식 변경</h1><h2 id="numpy-숫자-출력-형식-변경"><a href="#numpy-숫자-출력-형식-변경" class="headerlink" title="numpy 숫자 출력 형식 변경"></a>numpy 숫자 출력 형식 변경</h2><p><a target="_blank" rel="noopener" href="https://numpy.org/doc/stable/reference/generated/numpy.set_printoptions.html">numpy.set_printoptions</a> 을 사용할 수 있다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">numpy.set_printoptions(precision=<span class="literal">None</span>, threshold=<span class="literal">None</span>, edgeitems=<span class="literal">None</span>, linewidth=<span class="literal">None</span>, suppress=<span class="literal">None</span>,</span><br><span class="line">                       nanstr=<span class="literal">None</span>, infstr=<span class="literal">None</span>, formatter=<span class="literal">None</span>, sign=<span class="literal">None</span>, floatmode=<span class="literal">None</span>, *, legacy=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<h3 id="현재-출력형식-확인"><a href="#현재-출력형식-확인" class="headerlink" title="현재 출력형식 확인"></a>현재 출력형식 확인</h3><p><code>np.get_printoptions()</code> 으로 현재 상태를 출력할 수 있다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; np.get_printoptions()</span><br><span class="line">&#123;<span class="string">&#x27;edgeitems&#x27;</span>: <span class="number">3</span>,</span><br><span class="line"> <span class="string">&#x27;threshold&#x27;</span>: <span class="number">1000</span>,</span><br><span class="line"> <span class="string">&#x27;floatmode&#x27;</span>: <span class="string">&#x27;maxprec&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;precision&#x27;</span>: <span class="number">8</span>,</span><br><span class="line"> <span class="string">&#x27;suppress&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line"> <span class="string">&#x27;linewidth&#x27;</span>: <span class="number">75</span>,</span><br><span class="line"> <span class="string">&#x27;nanstr&#x27;</span>: <span class="string">&#x27;nan&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;infstr&#x27;</span>: <span class="string">&#x27;inf&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;sign&#x27;</span>: <span class="string">&#x27;-&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;formatter&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line"> <span class="string">&#x27;legacy&#x27;</span>: <span class="literal">False</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Numpy 에서 실수 Float 의 출력 형식을 바꾸는 몇가지 사례를 보자</p>
<h3 id="formatter-이용"><a href="#formatter-이용" class="headerlink" title="- formatter 이용"></a>- formatter 이용</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">np.set_printoptions(formatter=&#123;<span class="string">&#x27;float_kind&#x27;</span>: <span class="keyword">lambda</span> x: <span class="string">&quot;&#123;0:0.3f&#125;&quot;</span>.<span class="built_in">format</span>(x)&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="precision-이용"><a href="#precision-이용" class="headerlink" title="- precision 이용"></a>- precision 이용</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; np.set_printoptions(precision=<span class="number">4</span>)</span><br><span class="line">&gt; np.array([<span class="number">1.123456789</span>])</span><br><span class="line">[<span class="number">1.1235</span>]</span><br></pre></td></tr></table></figure>

<h3 id="threshold-이용"><a href="#threshold-이용" class="headerlink" title="- threshold 이용"></a>- threshold 이용</h3><p>개수가 많은 아이템을 출력할 때 요약해 출력할 수 있다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; np.set_printoptions(threshold=<span class="number">5</span>)</span><br><span class="line">&gt; np.arange(<span class="number">10</span>)</span><br><span class="line">array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, ..., <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>])</span><br></pre></td></tr></table></figure>


<h2 id="numpy-printoptions-사용"><a href="#numpy-printoptions-사용" class="headerlink" title="numpy.printoptions 사용"></a>numpy.printoptions 사용</h2><p><a target="_blank" rel="noopener" href="https://numpy.org/doc/stable/reference/generated/numpy.printoptions.html#numpy.printoptions">numpy.printoptions</a> 를 with 구문과 함께 사용해 제한된 출력 조정을 할 수 있다.</p>
<p>출력시 printoptions 를 with 구문과 사용할 수 있다. set_printoptions 의 인자를 동일하게 적용할 수 있다</p>
<ul>
<li>precision, threshold, edgeitems, linewidth, suppress, nanstr, infstr, formatter, sign, floatmode</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">numpy.printoptions(*args, **kwargs)[source]</span><br></pre></td></tr></table></figure>


<p>소수점 출력 변경</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; np.array([<span class="number">2.0</span>]) / <span class="number">3</span></span><br><span class="line">array([<span class="number">0.66666667</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">with</span> np.printoptions(precision=<span class="number">3</span>):</span><br><span class="line">&gt;    <span class="built_in">print</span>( np.array([<span class="number">2.0</span>]) / <span class="number">3</span> )</span><br></pre></td></tr></table></figure>

<br>

<h1 id="pandas-숫자-출력-형식-변경"><a href="#pandas-숫자-출력-형식-변경" class="headerlink" title="pandas 숫자 출력 형식 변경"></a>pandas 숫자 출력 형식 변경</h1><p>pandas에서 몇 가지 옵션을 바꾸는 방법을 정리해 보자. pandas의  옵션은 pd.options 를 사용한다.</p>
<h2 id="pd-options-display"><a href="#pd-options-display" class="headerlink" title="pd.options.display"></a>pd.options.display</h2><p>출력의 형태, 표기를 변경하는 것은 <code>pd.options.display</code> 아래에 있다. 여기서 사용할 수 있는 옵션은 <code>describe_option()</code> 으로 확인할 수 있다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.describe_option()</span><br><span class="line">compute.use_bottleneck : <span class="built_in">bool</span></span><br><span class="line">    Use the bottleneck library to accelerate <span class="keyword">if</span> it <span class="keyword">is</span> installed,</span><br><span class="line">    the default <span class="keyword">is</span> <span class="literal">True</span></span><br><span class="line">    Valid values: <span class="literal">False</span>,<span class="literal">True</span></span><br><span class="line">    [default: <span class="literal">True</span>] [currently: <span class="literal">True</span>]</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<h3 id="row-column-출력-개수-조정"><a href="#row-column-출력-개수-조정" class="headerlink" title="- row, column 출력 개수 조정"></a>- row, column 출력 개수 조정</h3><ul>
<li><code>pd.options.display.max_rows</code> : 표를 출력할 때 최대 행 수입니다.</li>
<li><code>pd.options.display.min_rows</code> : 표를 출력할 때 최소 행 수입니다.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">&gt; pd.options.display.max_rows</span><br><span class="line"><span class="number">60</span></span><br><span class="line">&gt; pd.options.display.min_rows</span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure>

<p><code>min_row</code>, <code>max_row</code>에 직접 대입하면 해당 옵션의 현재 값이 변경된다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.options.display.min_rows=<span class="number">100</span></span><br><span class="line">&gt; pd.options.display.min_rows</span><br><span class="line"><span class="number">100</span></span><br></pre></td></tr></table></figure>

<p><code>max_rows</code>에 값을 입력하면 테이블의 최대 행수를 바꿀 수 있다. </p>
<p><img src='https://miro.medium.com/v2/resize:fit:1400/1*WZssN58WwDaHilhzCE5T2Q.png'><sup> 이미지 참조 <a href="#footnote1">1</a></sup> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.options.display.max_rows = <span class="number">100</span></span><br><span class="line">&gt; pd.options.display.max_rows</span><br><span class="line"><span class="number">100</span></span><br></pre></td></tr></table></figure>


<h3 id="pd-get-option-pd-set-option-함수"><a href="#pd-get-option-pd-set-option-함수" class="headerlink" title="- pd.get_option(), pd.set_option() 함수"></a>- <code>pd.get_option()</code>, <code>pd.set_option()</code> 함수</h3><p><code>pd.get_option()</code> 함수를 이용해서 옵션인자에 대한 정보를 확인할 수 있다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.get_option(<span class="string">&#x27;min_rows&#x27;</span>)</span><br><span class="line"><span class="number">100</span></span><br></pre></td></tr></table></figure>

<p>get_option은 옵션 이름의 일부만 일치해도 된다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.get_option(<span class="string">&#x27;min_r&#x27;</span>)</span><br><span class="line"><span class="number">100</span></span><br></pre></td></tr></table></figure>
<p>max_rows 수를 설정한다. set_option도 일부만 일치해도 된다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.set_option(<span class="string">&#x27;max_rows&#x27;</span>, <span class="number">20</span>)</span><br><span class="line">&gt; pd.options.display.max_rows</span><br><span class="line"><span class="number">20</span></span><br><span class="line">&gt; pd.set_option(<span class="string">&#x27;max_r&#x27;</span>, <span class="number">50</span>)</span><br><span class="line">&gt; pd.options.display.max_rows</span><br><span class="line"><span class="number">50</span></span><br></pre></td></tr></table></figure>


<h3 id="컬럼의-폭-조정"><a href="#컬럼의-폭-조정" class="headerlink" title="- 컬럼의 폭 조정"></a>- 컬럼의 폭 조정</h3><p><code>display.max_colwidth</code> 는 보통 50~70자 정도 정해져 있다. 컬럼에 표시되는 텍스트가 50자가 넘으면 <code>...</code> 줄임 표시가 나타난다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.options.display.max_colwidth</span><br><span class="line"><span class="number">50</span></span><br></pre></td></tr></table></figure>



<h3 id="chop-threshold"><a href="#chop-threshold" class="headerlink" title="- chop_threshold"></a>- chop_threshold</h3><p><code>chop_threshold</code> 는 값의 크기 한계를 지정해서 이 값보다 작은 수는 모두 0으로 표시한다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.options.display.chop_threshold = <span class="number">0.99</span></span><br><span class="line">&gt; pd.DataFrame(&#123;<span class="string">&#x27;x&#x27;</span>: [<span class="number">10</span>, <span class="number">1</span>, <span class="number">0.1</span>]&#125;)</span><br><span class="line">&gt; <span class="built_in">print</span>(x)</span><br><span class="line"><span class="number">0</span>	<span class="number">10.0</span></span><br><span class="line"><span class="number">1</span>	<span class="number">1.0</span></span><br><span class="line"><span class="number">2</span>	<span class="number">0.0</span></span><br></pre></td></tr></table></figure>

<h2 id="숫자-포매팅"><a href="#숫자-포매팅" class="headerlink" title="숫자 포매팅"></a>숫자 포매팅</h2><p>다양한 사례는:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://pandas.pydata.org/docs/user_guide/options.html#number-formatting">https://pandas.pydata.org/docs/user_guide/options.html#number-formatting</a></li>
</ul>
<h3 id="float-format"><a href="#float-format" class="headerlink" title="- float_format"></a>- float_format</h3><p><code>float_format</code> 는 실수 값을 출력시 소수점의 출력의 정밀도를 조정할 수 있다. 아래 람다 함수 <code>lambda x: f&#39;&#123;x:.1f&#125;</code> 는 실수 x를 받아 소수점 첫째 자리까지 출력해 준다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.options.display.float_format = <span class="keyword">lambda</span> x: <span class="string">f&#x27;<span class="subst">&#123;x:<span class="number">.1</span>f&#125;</span>&#x27;</span></span><br><span class="line">&gt; pd.DataFrame(&#123;<span class="string">&#x27;x&#x27;</span>: [<span class="number">3.141592</span>]&#125;)</span><br><span class="line">x</span><br><span class="line"><span class="number">0</span>	<span class="number">3.1</span></span><br></pre></td></tr></table></figure>

<p>또한 set_option 을 사용할 수 있다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.set_option(<span class="string">&#x27;display.float_format&#x27;</span>, <span class="string">&#x27;&#123;:.2f&#125;&#x27;</span>.foramt )</span><br></pre></td></tr></table></figure>

<p>금액 단위에 사용하는 천단위 구분을 위해서 <code>&#123;:,.2f&#125;</code>  형식을 사용하면 화폐 단위를 추가하고 천단위 구분자를 추가해 주고 소수점 2자리수 정밀로를 지정한다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.set_option(<span class="string">&#x27;display.float_format&#x27;</span>, <span class="string">&#x27;$&#123;:,.2f&#125;&#x27;</span>.<span class="built_in">format</span> )</span><br><span class="line">&gt; pd.DataFrame(&#123;<span class="string">&#x27;x&#x27;</span>: [<span class="number">10000000.0</span>, <span class="number">34589234.4</span>]&#125;)</span><br><span class="line">  x</span><br><span class="line"><span class="number">0</span> $<span class="number">10</span>,<span class="number">000</span>,<span class="number">000.00</span></span><br><span class="line"><span class="number">1</span> $<span class="number">34</span>,<span class="number">589</span>,<span class="number">234.40</span></span><br></pre></td></tr></table></figure>



<h3 id="precision"><a href="#precision" class="headerlink" title="- precision"></a>- precision</h3><p>실수의 소수점은 <code>precision</code> 로 과학적 표기법으로 변환할 자릿수를 지정한다. 아래와 같이 하면 소수점 셋째 자리 밑으로는 과학적 표기법으로 표시합니다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.options.display.precision = <span class="number">3</span></span><br><span class="line">&gt; pd.DataFrame(&#123;<span class="string">&#x27;x&#x27;</span>: [<span class="number">0.5</span>], <span class="string">&#x27;y&#x27;</span>: [<span class="number">0.0005</span>]&#125;)</span><br><span class="line">x	y</span><br><span class="line"><span class="number">0</span>	<span class="number">0.5</span>	<span class="number">5.000e-04</span></span><br></pre></td></tr></table></figure>

<p>과학적 표기법으로 3.000e-04는 3.000 이다. 자릿수가 아주 작거나 큰 수를 표기할 때 유용합니다.</p>
<h3 id="설정-초기화-reset-option"><a href="#설정-초기화-reset-option" class="headerlink" title="- 설정 초기화 reset_option()"></a>- 설정 초기화 <code>reset_option()</code></h3><p>설정을 초기화할 때 사용한다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># chop_threshold 옵션 초기화</span></span><br><span class="line">pd.reset_option(<span class="string">&#x27;display.chop_threshold&#x27;</span>)</span><br><span class="line"><span class="comment"># float_format 옵션 초기화</span></span><br><span class="line">pd.reset_option(<span class="string">&#x27;display.float_format&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="옵션-설명-describe-option"><a href="#옵션-설명-describe-option" class="headerlink" title="- 옵션 설명 describe_option()"></a>- 옵션 설명 <code>describe_option()</code></h3><p><code>pd.describe_option(OPTIONS)</code> 를 사용하면 해당 옵션에 대한 설명을 출력해 준다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; pd.describe_option(<span class="string">&quot;max_rows&quot;</span>)</span><br><span class="line">display.max_rows : <span class="built_in">int</span></span><br><span class="line">    If max_rows <span class="keyword">is</span> exceeded, switch to truncate view. Depending on</span><br><span class="line">    `large_repr`, objects are either centrally truncated <span class="keyword">or</span> printed <span class="keyword">as</span></span><br><span class="line">    a summary view. <span class="string">&#x27;None&#x27;</span> value means unlimited.</span><br></pre></td></tr></table></figure>


<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><p><a name='footnote1'>1</a>: <a target="_blank" rel="noopener" href="https://pub.towardsai.net/try-these-pandas-display-configurations-in-your-next-analysis-72589648d9a0">Try These Pandas Display Configurations</a></p>
<p><a name='footnote1'>2</a>: <a target="_blank" rel="noopener" href="https://pandas.pydata.org/docs/user_guide/options.html">Pandas options</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-09T00:00:00.000Z" title="7/9/2023, 9:00:00 AM">2023-07-09</time>&nbsp;게시 됨</span><span class="level-item"><time dateTime="2023-07-09T05:31:39.385Z" title="7/9/2023, 2:31:39 PM">2023-07-09</time>&nbsp;업데이트 됨</span><span class="level-item"><a class="link-muted" href="/categories/Programming/">Programming</a><span> / </span><a class="link-muted" href="/categories/Programming/Python/">Python</a></span><span class="level-item">15분안에 읽기 (약 2261 단어)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/python-packaging-start-48993e24137b/">Python - 파이썬 프로젝트 패키징과 배포하기</a></p><div class="content"><p>파이썬에서 작업한 소스를 공개&#x2F;비공개 배포하기 위해서 패키징을 하는 방법을 요약, 정리했다.</p>
<h1 id="파이썬-모듈-배포하기"><a href="#파이썬-모듈-배포하기" class="headerlink" title="파이썬 모듈 배포하기"></a>파이썬 모듈 배포하기</h1><p>이 글은 setuptools, builds 그리고 PyPI 업로드를 위한 twine 를 사용하고 있다.</p>
<h2 id="핵심-용어"><a href="#핵심-용어" class="headerlink" title="[핵심 용어]"></a>[핵심 용어]</h2><ul>
<li><a target="_blank" rel="noopener" href="https://pypi.org/">PyPi, Python Package Index</a>: 파이썬 사용자를 위한 오픈소스 패키지의 공개 저장소 일명 PyPi</li>
<li><a target="_blank" rel="noopener" href="https://www.pypa.io/">PyPa, 파이썬 패키징 위원회</a>: 표준 패키징 도구&#x2F;메타 데이터&#x2F;파일 형식 표준을 GitHub 와 Bitbucket 을 통해서 여러 패키징 도구, 문서, 이슈 추적기를 관리하고 있다.</li>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/ko/3/library/distutils.html#module-distutils">distutils</a>: 1998년&#x2F;파이썬 표준 라이브러리 최초의 빌드 및 배포 시스템. 대부분 직접 사용이 단계적으로 폐지되고 있다.<ul>
<li>distutils는 파이썬 3.10부터 deprecated, 3.12에서 <em><strong>삭제</strong></em>될 예정.</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://setuptools.readthedocs.io/en/latest/">setuptools</a> : 2004 공개&#x2F; distutils 의 드롭인(drop-in) 대체품. distutils 와 큰 차이는 다른 패키지에 대한 의존성을 선언할 수 있다.</li>
<li>[pyproject.toml]: 2016년 setuptools의 메타 파일 setup.py 의존성을 피하고자 독립한 빌드용 선언적 메타정보 파일.</li>
<li><a target="_blank" rel="noopener" href="https://wheel.readthedocs.io/">wheel</a>: distutils&#x2F;setuptools 에 bdist_wheel 명령을 추가하는 프로젝트이다. 파이썬 라이브러리를 바이너리 확장을 포함&#x2F;크로스 플랫폼 바이너리 패키징 형식 지원 (“휠”,”휠 파일”, <a target="_blank" rel="noopener" href="https://peps.python.org/pep-0427/">PEP 427</a> 정의).</li>
</ul>
<h2 id="도구-설치"><a href="#도구-설치" class="headerlink" title="도구 설치"></a>도구 설치</h2><p>setuptools 기반 배포도구 설치</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install setuptools wheel twine</span><br></pre></td></tr></table></figure>


<h2 id="파이썬-패키징"><a href="#파이썬-패키징" class="headerlink" title="파이썬 패키징"></a>파이썬 패키징</h2><p><a target="_blank" rel="noopener" href="https://packaging.python.org/en/latest/tutorials/packaging-projects/">https://packaging.python.org/en/latest/tutorials/packaging-projects/</a> 내용을 요약, 정리, 보충한다.</p>
<h3 id="프로젝트-생성"><a href="#프로젝트-생성" class="headerlink" title="프로젝트 생성"></a>프로젝트 생성</h3><blockquote>
<p>패키징 수행하면 별도의 가상환경을 생성해서 진행한다.</p>
</blockquote>
<p>프로젝트를 패키징하는 과정을 위해서 packaging_tutorial 폴더 아래에 같은 구조를 갖는다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">packaging_tutorial/</span><br><span class="line">└── src/</span><br><span class="line">    └── example_package_YOUR_USERNAME_HERE/</span><br><span class="line">        ├── __init__.py</span><br><span class="line">        └── example.py</span><br></pre></td></tr></table></figure>

<ul>
<li><code>example_package_YOUR_USERNAME_HERE</code> : 프로젝트 이름이고 중복하지 않게 한다.</li>
<li><code>__init__.py</code> : 빈 파일로 폴더를 패키지로 인식하게 한다.</li>
<li><code>example.py</code> : 모듈.</li>
</ul>
<p> <code>example.py</code> 모듈 소스.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_one</span>(<span class="params">number</span>):</span><br><span class="line">    <span class="keyword">return</span> number + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="패키징용-파일-생성"><a href="#패키징용-파일-생성" class="headerlink" title="패키징용 파일 생성"></a>패키징용 파일 생성</h3><p>배포를 위한 프로젝트의 구성을 위해 패키징에 필요한 파일을 추가한 구조는 아래 같다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">packaging_tutorial/</span><br><span class="line">├── LICENSE</span><br><span class="line">├── pyproject.toml</span><br><span class="line">├── README.md</span><br><span class="line">└── src/</span><br><span class="line">│   └── example_package_YOUR_USERNAME_HERE/</span><br><span class="line">│       ├── __init__.py</span><br><span class="line">│       └── example.py</span><br><span class="line">└── tests/</span><br></pre></td></tr></table></figure>
<ul>
<li><code>LICENSE</code> : 라이센서 선언</li>
<li><code>pyproject.toml</code> : 프로젝트 배포 프로젝트 생성에 사용하는 프론트엔드 빌드도구 <code>pip</code>, 백엔드 밸드도구 <code>build</code>  </li>
<li><code>README.md</code></li>
<li><code>tests/</code> : 테스트 파일용 공간. Leave it empty for now.</li>
</ul>
<blockquote>
<p>패키징의 프론트엔드, 백엔드는 참조의 5번 항목을 살펴보자.</p>
</blockquote>
<h3 id="pyproject-toml-구성"><a href="#pyproject-toml-구성" class="headerlink" title="pyproject.toml 구성"></a><code>pyproject.toml</code> 구성</h3><p>보통 파일 내용은 아래 항목으로 구성한다. 이 파일은 TOML 형식의 구조를 따르고 있다. 여기에 대해서는 아래 참조 4번 항목 내용을 보기 바란다.</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[build-system]</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="section">[project]</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="section">[project.urls]</span></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>빌드 도구를 명시하는 명세서 <code>pyproject.toml</code>에 setuptools 를 사용한 예이다.</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[build-system]</span></span><br><span class="line"><span class="attr">requires</span> = [<span class="string">&quot;setuptools&gt;=61.0&quot;</span>]</span><br><span class="line"><span class="attr">build-backend</span> = <span class="string">&quot;setuptools.build_meta&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>requires</code> : 빌드용 도구 지시.</li>
<li><code>build-backend</code> :  프론트엔드 (pip)에서 빌드에 사용하는 백엔드 도구</li>
</ul>
<p>다음은 Hatching 이란 빌드 도구를 사용한 예이다.</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[build-system]</span></span><br><span class="line"><span class="attr">requires</span> = [<span class="string">&quot;hatchling&quot;</span>]</span><br><span class="line"><span class="attr">build-backend</span> = <span class="string">&quot;hatchling.build&quot;</span></span><br></pre></td></tr></table></figure>

<p>메타 정보를 포함한 간단한  <code>pyproject.toml</code> 구성 결과.</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[build-system]</span></span><br><span class="line"><span class="attr">requires</span> = [<span class="string">&quot;setuptools&gt;=61.0&quot;</span>]</span><br><span class="line"><span class="attr">build-backend</span> = <span class="string">&quot;setuptools.build_meta&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[project]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;example_package_YOUR_USERNAME_HERE&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.0.1&quot;</span></span><br><span class="line"><span class="attr">authors</span> = [</span><br><span class="line">  &#123; name=<span class="string">&quot;Example Author&quot;</span>, email=<span class="string">&quot;author@example.com&quot;</span> &#125;,</span><br><span class="line">]</span><br><span class="line"><span class="attr">description</span> = <span class="string">&quot;A small example package&quot;</span></span><br><span class="line"><span class="attr">readme</span> = <span class="string">&quot;README.md&quot;</span></span><br><span class="line"><span class="attr">requires-python</span> = <span class="string">&quot;&gt;=3.7&quot;</span></span><br><span class="line"><span class="attr">classifiers</span> = [</span><br><span class="line">    <span class="string">&quot;Programming Language :: Python :: 3&quot;</span>,</span><br><span class="line">    <span class="string">&quot;License :: OSI Approved :: MIT License&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Operating System :: OS Independent&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="section">[project.urls]</span></span><br><span class="line"><span class="attr">&quot;Homepage&quot;</span> = <span class="string">&quot;https://github.com/pypa/sampleproject&quot;</span></span><br><span class="line"><span class="attr">&quot;Bug Tracker&quot;</span> = <span class="string">&quot;https://github.com/pypa/sampleproject/issues&quot;</span></span><br></pre></td></tr></table></figure>

<p>자세한 메타 정보 내역은 <a target="_blank" rel="noopener" href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata/#declaring-project-metadata">프로젝트 메타정보 정의</a>를 참조한다. 주요 메타 정보의 인자:</p>
<ul>
<li><code>[project]</code>:<ul>
<li>requires-python : 패키지가 요구하는 최소 파이썬 버전 명시</li>
<li>classifiers: pip가 인지하는 패키지에 대한 정보</li>
</ul>
</li>
</ul>
<h3 id="README-md-x2F-LICENSE-파일"><a href="#README-md-x2F-LICENSE-파일" class="headerlink" title="README.md &#x2F; LICENSE 파일"></a>README.md &#x2F; LICENSE 파일</h3><p>README.md 파일에 패키지 모듈를 설명한다.</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Example Package</span></span><br><span class="line"></span><br><span class="line">This is a simple example package. You can use</span><br><span class="line">[<span class="string">Github-flavored Markdown</span>](<span class="link">https://guides.github.com/features/mastering-markdown/</span>)</span><br><span class="line">to write your content.</span><br></pre></td></tr></table></figure>

<p>LICENSE 파일에 저작권을 명시한다.</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Copyright (c) 2018 The Python Packaging Authority</span><br><span class="line"></span><br><span class="line">Permission is hereby granted, free of charge, to any person obtaining a copy</span><br></pre></td></tr></table></figure>

<h2 id="배포-묶음-생성하기"><a href="#배포-묶음-생성하기" class="headerlink" title="배포 묶음 생성하기"></a>배포 묶음 생성하기</h2><p>배포를 위한 build 도구를 설치한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install --upgrade build</span><br></pre></td></tr></table></figure>

<p><code>packaging_tutorial</code> 폴더 아래 pyproject.toml 파일이 있는 위치에서 배포를 위한 build 명령으로 소스를 패키징을 한다. </p>
<p>build 를 수행하면 별도의 venv 가상환경을 생성해서 의존성에 명시된 setuptools 등을 설치하고 빌드를 진행한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">python3 -m build</span></span><br><span class="line">* Creating venv isolated environment...</span><br><span class="line">* Installing packages in isolated environment... (setuptools&gt;=61.0)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">removing build\bdist.win-amd64\wheel</span><br><span class="line">Successfully built example_package_YOUR_USERNAME_HERE-0.0.1.tar.gz and example_package_YOUR_USERNAME_HERE-0.0.1-py3-none-any.whl</span><br></pre></td></tr></table></figure>

<p>이 명령의 결과로 <code>dist</code> 폴더에 우리 프로젝트에 대한 배포용 패키징으로 소스 패키징 <code>.gz</code> 파일, built distribution 패키징 <code>.whl</code> 2개의 파일이 생성된다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dist/</span><br><span class="line">├── example_package_YOUR_USERNAME_HERE-0.0.1-py3-none-any.whl</span><br><span class="line">└── example_package_YOUR_USERNAME_HERE-0.0.1.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="pip-로-wheeels-설치하기"><a href="#pip-로-wheeels-설치하기" class="headerlink" title="pip 로 wheeels 설치하기"></a>pip 로 wheeels 설치하기</h3><p>pip 에서 built distribution 파일을 직접 설치할 수 있다. <a target="_blank" rel="noopener" href="https://pip.pypa.io/en/stable/user_guide/#installing-from-wheels">installing-from-wheels</a> 참조.</p>
<p>다음은 우리 프로젝트의 wheel 패키징을 설치한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install example_package_YOUR_USERNAME_HERE-0.0.1-py3-none-any.whl</span><br></pre></td></tr></table></figure>

<p>혹은 provides_extras 메타 정보를 사용해 추가 설치를 한다면,</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install &#x27;./somepackage-1.0-py2.py3-none-any.whl[my-extras]&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h2><p>처음 PyPi 에 업로드를 하려면 아래 2가지 단계를 거쳐서 진행해 본다.</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://test.pypi.org/account/register/">https://test.pypi.org/account/register/</a> 에서 등록<ol>
<li>실제 pypi 가 아닌 튜토리얼과 테스트를 위한 곳.</li>
</ol>
</li>
<li>PyPi 업로드를 완성하려면 PyPI API token 을 발급받아야 한다.<ol>
<li><a target="_blank" rel="noopener" href="https://test.pypi.org/manage/account/#api-tokens">https://test.pypi.org/manage/account/#api-tokens</a></li>
</ol>
</li>
</ol>
<p>PyPI에 업로드가 완료되면 pip 를 통해서 패키지를 설치할 수 있다. 업로드를 위해서 Twin 패키지를 설치하고 사용해야 한다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install --upgrade twine</span><br></pre></td></tr></table></figure>

<p>twine 모듈을 사용해서 dist&#x2F; 아래의 모든 소스&#x2F;휠 패키징 묶음을 업로드할 수 있다. 지금은 <code>testpypi</code> 에 업로드를 해보자.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m twine upload --repository testpypi dist/*</span><br></pre></td></tr></table></figure>
<ul>
<li>업로드시 username은  <code>__token__</code> 사용.</li>
<li>패스워드는 발급받은 <code>pypi-</code> 으로 시작하는 token 값.</li>
</ul>
<p>업로드 진행은 아래 같을 것이다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Uploading distributions to https://test.pypi.org/legacy/</span><br><span class="line">Enter your username: __token__</span><br><span class="line">Uploading example_package_YOUR_USERNAME_HERE-0.0.1-py3-none-any.whl</span><br><span class="line">100% ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 8.2/8.2 kB • 00:01 • ?</span><br><span class="line">Uploading example_package_YOUR_USERNAME_HERE-0.0.1.tar.gz</span><br><span class="line">100% ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 6.8/6.8 kB • 00:00 • ?</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>여기서 repository로 testpypi 를 지정했으므로 업로드한 결과는 다음 같이 확인할 수 있다.</p>
<ul>
<li><code>https://test.pypi.org/project/example_package_YOUR_USERNAME_HERE</code></li>
</ul>
<h3 id="저장소에서-설치하기"><a href="#저장소에서-설치하기" class="headerlink" title="저장소에서 설치하기"></a>저장소에서 설치하기</h3><p>위에 testpypi 에 업로드한 패키지를 설치하려면 아래 같이 <code>--index-url</code> 로 저장소를 지정해서 사용한다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install --index-url https://test.pypi.org/simple/ --no-deps example-package-YOUR-USERNAME-HERE</span><br></pre></td></tr></table></figure>

<h3 id="PyPI-에-업로드"><a href="#PyPI-에-업로드" class="headerlink" title="PyPI 에 업로드"></a>PyPI 에 업로드</h3><p>마지막으로 실제 패키지를 PyPI에 업로드하려면 <a target="_blank" rel="noopener" href="https://pypi.org/">https://pypi.org</a> 등록을 하고, 등록한 사용자 아이디를 사용하고 <code>--repository</code> 인자를 제외하고 업로드하면 된다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m twine upload dist/*</span><br></pre></td></tr></table></figure>

<h2 id="통합-메타-정보로서-pyproject-toml-활용"><a href="#통합-메타-정보로서-pyproject-toml-활용" class="headerlink" title="통합 메타 정보로서 pyproject.toml 활용"></a>통합 메타 정보로서 <code>pyproject.toml</code> 활용</h2><p>테스트, 코드 포맷팅 등에 대한 정보로 활용한다. 대표적으로는 코드 포맷팅 도구인 black, 테스트용 프레임워크인 pytest 등이 pyproject.toml에 설정 값을 저장하고 있다 - <a target="_blank" rel="noopener" href="https://ryanking13.github.io/2021/07/11/python-packaging.html">파이썬 패키징의 역사, blog</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># pyproject.toml of black</span><br><span class="line"><span class="punctuation">[</span>tool.black<span class="punctuation">]</span></span><br><span class="line">line-length = <span class="number">88</span></span><br><span class="line">target-version = <span class="punctuation">[</span>&#x27;py36&#x27;<span class="punctuation">,</span> &#x27;py37&#x27;<span class="punctuation">,</span> &#x27;py38&#x27;<span class="punctuation">]</span></span><br><span class="line">include = &#x27;\.pyi?$&#x27;</span><br></pre></td></tr></table></figure>

<h1 id="다음"><a href="#다음" class="headerlink" title="다음"></a>다음</h1><p>이후에 다른 빌드 도구들, 테스트 도구들을 다뤄보자.</p>
<ul>
<li>poetry: <ul>
<li><a target="_blank" rel="noopener" href="https://velog.io/@hj8853/Poetry%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-%EA%B0%80%EC%83%81%ED%99%98%EA%B2%BD-%EB%A7%8C%EB%93%A4%EA%B8%B0">Poetry를-사용하여-가상환경-만들기</a></li>
<li><a target="_blank" rel="noopener" href="https://mixedprograming.tistory.com/35">poetry를 사용한 파이썬 dependency관리</a></li>
</ul>
</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ol>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/ko/3/distributing/index.html">파이썬 모듈 배포하기, python.org</a></li>
<li><a target="_blank" rel="noopener" href="https://packaging.python.org/en/latest/guides/tool-recommendations/">Tool recommendations, python.org</a><ol>
<li>주요 패키징에 필요한 도구 안내</li>
</ol>
</li>
<li><a target="_blank" rel="noopener" href="https://ryanking13.github.io/2021/07/11/python-packaging.html">파이썬 패키징의 역사, blog</a></li>
<li><a target="_blank" rel="noopener" href="https://www.itworld.co.kr/news/248128">TOML의 이해와 기본 활용, itworld</a></li>
<li><a target="_blank" rel="noopener" href="https://devocean.sk.com/blog/techBoardDetail.do?ID=164866&boardType=techBlog">Python package의 build frontend 와 backend</a></li>
</ol>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/categories/Programming/">이전</a></div><div class="pagination-next"><a href="/categories/Programming/page/3/">다음</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/categories/Programming/">1</a></li><li><a class="pagination-link is-current" href="/categories/Programming/page/2/">2</a></li><li><a class="pagination-link" href="/categories/Programming/page/3/">3</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/categories/Programming/page/9/">9</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/images/qkboo_400.png" alt="Gangtai"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Gangtai</p><p class="is-size-6 is-block">Your title</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Paju, South Korea</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">포스트</p><a href="/archives"><p class="title">163</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">카테고리</p><a href="/categories"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">태그</p><a href="/tags"><p class="title">241</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/thinkbee" target="_blank" rel="noopener">팔로우</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/thinkbee"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/gangtaigoh"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">최근 글</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-05T10:00:00.000Z">2024-03-05</time></p><p class="title"><a href="/mariadb-transfer_to_other-a78fa3ae97d8/">MariaDb 10 이전하기</a></p><p class="categories"><a href="/categories/Programming/">Programming</a> / <a href="/categories/Programming/Database/">Database</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-03-05T00:00:00.000Z">2024-03-05</time></p><p class="title"><a href="/mariadb_install_on_linux-42c7d6483e3f/">MariaDB 설치</a></p><p class="categories"><a href="/categories/Programming/">Programming</a> / <a href="/categories/Programming/Database/">Database</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-02-08T00:00:00.000Z">2024-02-08</time></p><p class="title"><a href="/python_sphinx-487d92e77816/">Python - 문서화 도구 Sphinx</a></p><p class="categories"><a href="/categories/Programming/">Programming</a> / <a href="/categories/Programming/Python/">Python</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-01-26T13:00:00.000Z">2024-01-26</time></p><p class="title"><a href="/git_autocrlf-4760600f2cc5/">git 에서 줄바꿈 문제 - CRLF, LF</a></p><p class="categories"><a href="/categories/Programming/">Programming</a> / <a href="/categories/Programming/git/">git</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-25T00:40:00.000Z">2023-10-25</time></p><p class="title"><a href="/git-swallow-branch-e1aedce9cb6d/">[git] Swallow clone 과 브랜치</a></p><p class="categories"><a href="/categories/Programming/">Programming</a> / <a href="/categories/Programming/git/">git</a></p></div></article></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">광고</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1465716454138955" data-ad-slot="4441624809" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">카테고리</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/AI/"><span class="level-start"><span class="level-item">AI</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/ETC/"><span class="level-start"><span class="level-item">ETC</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/IT/"><span class="level-start"><span class="level-item">IT</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/OS/"><span class="level-start"><span class="level-item">OS</span></span><span class="level-end"><span class="level-item tag">55</span></span></a><ul><li><a class="level is-mobile" href="/categories/OS/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">28</span></span></a></li><li><a class="level is-mobile" href="/categories/OS/Raspberry-Pi/"><span class="level-start"><span class="level-item">Raspberry Pi</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile" href="/categories/OS/Windows/"><span class="level-start"><span class="level-item">Windows</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">90</span></span></a><ul><li><a class="level is-mobile" href="/categories/Programming/Android/"><span class="level-start"><span class="level-item">Android</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Angularjs/"><span class="level-start"><span class="level-item">Angularjs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/C-C/"><span class="level-start"><span class="level-item">C/C++</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Database/"><span class="level-start"><span class="level-item">Database</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Nodejs/"><span class="level-start"><span class="level-item">Nodejs</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">28</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/R/"><span class="level-start"><span class="level-item">R</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/git/"><span class="level-start"><span class="level-item">git</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/github/"><span class="level-start"><span class="level-item">github</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/thinkbee_logo.png" alt="IT Tech blogging" height="28"></a><p class="is-size-7"><span>&copy; 2024 Gangtai Goh</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("ko");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="맨 위로" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-right",
        content: {
          message: "이 웹 사이트는 귀하의 경험을 향상시키기 위해 Cookie를 사용합니다.",
          dismiss: "무시",
          allow: "허용",
          deny: "거부",
          link: "더 알아보기",
          policy: "Cookie 정책",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="입력 하세요..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"입력 하세요...","untitled":"(제목 없음)","posts":"포스트","pages":"페이지","categories":"카테고리","tags":"태그"});
        });</script></body></html>